<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mullai Store</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* New Color Design */
        :root {
            --color-bg: #f0f4f8;
            --color-card: #ffffff;
            --color-primary: #5a67d8;
            --color-primary-dark: #434190;
            --color-accent: #2e8b57;
            --color-accent-dark: #226f43;
            --color-text-main: #1a202c;
            --color-text-secondary: #718096;
            --color-border: #e2e8f0;
            --color-input: #f7fafc;
            --color-table-header: #edf2f7;
            --color-table-row-hover: #f7fafc;
            --color-danger: #e53e3e;
            --color-success: #38a169;
            --color-warning: #ecc94b;
        }
        .dark-mode {
            --color-bg: #1a202c;
            --color-card: #2d3748;
            --color-primary: #a5b4fc;
            --color-primary-dark: #6366f1;
            --color-accent: #38b2ac;
            --color-accent-dark: #319795;
            --color-text-main: #e2e8f0;
            --color-text-secondary: #a0aec0;
            --color-border: #4a5568;
            --color-input: #4a5568;
            --color-table-header: #4a5568;
            --color-table-row-hover: #2d3748;
            --color-danger: #fc8181;
            --color-success: #68d391;
            --color-warning: #f6e05e;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .nav-btn { background-color: transparent; color: var(--color-text-secondary); }
        .nav-btn.active, .nav-btn:hover { background-color: var(--color-border); color: var(--color-primary); }
        .dark-mode .nav-btn.active, .dark-mode .nav-btn:hover { background-color: var(--color-border); color: var(--color-accent); }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .input-style { background-color: var(--color-input); border-color: var(--color-border); }
        .table-header { background-color: var(--color-table-header); }
        .table-row:hover { background-color: var(--color-table-row-hover); }

        /* Loader CSS: Paint Shop Animation */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .hidden { display: none; }
        .loader-container {
            width: 100px;
            height: 100px;
            position: relative;
        }
        .paint-drip {
            position: absolute;
            bottom: 0;
            width: 15px;
            height: 0;
            background-color: var(--color-primary);
            animation: drip 1.5s cubic-bezier(0.65, 0.05, 0.36, 1) infinite;
        }
        .paint-drip:nth-child(2) { left: 20px; animation-delay: 0.1s; }
        .paint-drip:nth-child(3) { left: 40px; animation-delay: 0.2s; }
        .paint-drip:nth-child(4) { left: 60px; animation-delay: 0.3s; }
        .paint-drip:nth-child(5) { left: 80px; animation-delay: 0.4s; }
        @keyframes drip {
            0% { transform: translateY(0); height: 0; opacity: 1; }
            50% { transform: translateY(50px); height: 50px; opacity: 1; }
            100% { transform: translateY(100px); height: 50px; opacity: 0; }
        }

        /* Message Bar CSS */
        #message-bar {
            position: fixed;
            top: -100px; /* Start off-screen */
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 600px;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 9998;
            transition: top 0.5s ease-in-out;
            text-align: center;
        }
        #message-bar.show { top: 1rem; }
        #message-bar.success { background-color: var(--color-success); color: white; }
        #message-bar.error { background-color: var(--color-danger); color: white; }
        #message-bar.warning { background-color: var(--color-warning); color: white; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <div id="message-bar"></div>

    <div id="loader" class="loader-overlay hidden">
        <div class="loader-container">
            <div class="paint-drip"></div>
            <div class="paint-drip"></div>
            <div class="paint-drip"></div>
            <div class="paint-drip"></div>
            <div class="paint-drip"></div>
        </div>
    </div>
    
    <header class="card p-4 shadow-md">
        <div class="container mx-auto flex flex-col sm:flex-row items-center justify-between space-y-4 sm:space-y-0">
            <h1 class="text-3xl font-bold">MULLAI STORE</h1>
            <nav class="flex flex-wrap items-center justify-center space-x-2 sm:space-x-4">
                <button data-target="dashboard" class="nav-btn px-4 py-2 rounded-full">Dashboard</button>
                <button data-target="stock" class="nav-btn px-4 py-2 rounded-full">Stock Management</button>
                <button data-target="invoice" class="nav-btn px-4 py-2 rounded-full">Invoice</button>
                <button data-target="sales" class="nav-btn px-4 py-2 rounded-full">Sales Details</button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark-mode:bg-gray-700">
                    <svg id="sun-icon" class="w-6 h-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 11a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-4-4a5 5 0 100 10 5 5 0 000-10zM4 13a1 1 0 01-1 1H2a1 1 0 110-2h1a1 1 0 011 1zm12-2a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-1-6a1 1 0 010-2l.707-.707a1 1 0 011.414 0l.707.707a1 1 0 010 1.414L16.707 6a1 1 0 01-1.414 0L15 5.293zM5.293 6L4.586 5.293a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414L5.293 6zM15 15a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-6-2a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z"/></svg>
                    <svg id="moon-icon" class="w-6 h-6 text-gray-800" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                </button>
            </nav>
        </div>
    </header>

    <main class="flex-1 p-4 sm:p-8 container mx-auto">
        <section id="dashboard" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl active">
            <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="total-stock-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                    <div>
                        <p class="text-sm font-medium opacity-80">Total Stock Value</p>
                        <p id="total-stock-value" class="text-4xl font-bold"></p>
                    </div>
                </div>
                <div class="total-sales-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                    <div>
                        <p class="text-sm font-medium opacity-80">Total Sales</p>
                        <p id="total-sales-amount" class="text-4xl font-bold"></p>
                    </div>
                </div>
                <div class="low-stock-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                    <div>
                        <p class="text-sm font-medium opacity-80">Low Stock Items</p>
                        <p id="low-stock-count" class="text-4xl font-bold"></p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 dark-mode:bg-gray-800 p-6 rounded-2xl shadow-inner">
                <h3 class="text-xl font-bold mb-4">Low Stock Items (<span id="low-stock-count-list"></span>)</h3>
                <div id="low-stock-list" class="overflow-y-auto max-h-80">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr class="text-left">
                                <th class="p-3">Code</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Quantity</th>
                            </tr>
                        </thead>
                        <tbody id="low-stock-table-body" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="stock" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Stock Management</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6 items-center">
                <button id="btn-import-csv" class="px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 col-span-1">Import CSV</button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                <button id="btn-export-csv" class="px-6 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 col-span-1">Export CSV</button>
                <button id="btn-export-pdf" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 col-span-1">Export PDF</button>
                <input type="text" id="add-stock-code" placeholder="Stock Code" class="p-3 border rounded-xl input-style col-span-1">
                <input type="text" id="add-stock-name" placeholder="Name" class="p-3 border rounded-xl input-style col-span-1">
                <input type="number" id="add-stock-price" placeholder="Price" class="p-3 border rounded-xl input-style col-span-1">
                <input type="number" id="add-stock-quantity" placeholder="Quantity" class="p-3 border rounded-xl input-style col-span-1">
                <button id="btn-add-stock" class="px-6 py-3 btn-primary rounded-xl col-span-full md:col-span-1">Add New Stock</button>
            </div>

            <div class="card p-6 rounded-xl shadow-inner">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="select-all-stock" class="form-checkbox h-5 w-5 rounded-md">
                        <label for="select-all-stock">Select All</label>
                    </div>
                    <div class="flex space-x-2">
                        <button id="btn-edit-selected" class="px-4 py-2 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600">Edit Selected</button>
                        <button id="btn-delete-selected" class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600">Delete Selected</button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr class="text-left">
                                <th class="p-3"></th>
                                <th class="p-3">Code</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Quantity</th>
                                <th class="p-3">Price</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="invoice" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Create Invoice</h2>
            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Invoice No:</span>
                        <input type="text" id="invoice-no" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 input-style" readonly>
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Invoice Date:</span>
                        <input type="date" id="invoice-date" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Customer Name:</span>
                        <input type="text" id="customer-name" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Phone:</span>
                        <input type="tel" id="customer-phone" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Email:</span>
                        <input type="email" id="customer-email" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Address:</span>
                        <input type="text" id="customer-address" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                </div>

                <div class="flex items-center gap-4 flex-wrap">
                    <label class="block flex-1">
                        <span class="text-gray-500">Enter Stock Code:</span>
                        <input type="text" id="stock-code-input" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <button id="add-item-btn" class="px-6 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 self-end">Add Item</button>
                </div>

                <div class="card p-4 rounded-xl shadow-inner overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr class="text-left">
                                <th class="p-3">Name</th>
                                <th class="p-3">Unit Price</th>
                                <th class="p-3">Quantity</th>
                                <th class="p-3">Discount (%)</th>
                                <th class="p-3">GST (%)</th>
                                <th class="p-3">Total</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="invoice-item-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-col items-end space-y-2 text-right text-lg font-medium">
                    <p class="text-gray-500">Subtotal: <span id="subtotal" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-gray-500">Total Discount: <span id="total-discount" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-gray-500">Total GST: <span id="total-gst" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-2xl font-bold">Grand Total: <span id="grand-total" class="text-blue-600 dark-mode:text-cyan-400">0.00</span></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Payment Mode:</span>
                        <select id="payment-mode" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                            <option value="Cash">Cash</option>
                            <option value="Card">Card</option>
                            <option value="UPI">UPI</option>
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Paid Amount:</span>
                        <input type="number" id="paid-amount" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Balance:</span>
                        <input type="number" id="balance" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 input-style" readonly>
                    </label>
                </div>

                <div class="relative w-full">
                    <button id="save-print-btn" class="w-full px-6 py-4 btn-primary text-xl font-bold rounded-xl">
                        Save & Print Invoice
                    </button>
                </div>
            </div>
        </section>

        <section id="sales" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Sales Details</h2>
            <div class="overflow-x-auto rounded-lg card">
                <table class="min-w-full">
                    <thead class="table-header">
                        <tr class="text-left">
                            <th class="p-3">Date/Time</th>
                            <th class="p-3">Invoice No.</th>
                            <th class="p-3">Customer Name</th>
                            <th class="p-3">Total Amount</th>
                            <th class="p-3">Return Status</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sales-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="invoice-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-2xl w-full">
            <div id="invoice-bill-content" class="p-4 border-2 border-dashed border-gray-300 dark-mode:border-gray-600 rounded-lg">
            </div>
            <div class="no-print mt-6 flex justify-end space-x-4">
                <button onclick="window.print()" class="px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600">Print</button>
                <button id="close-invoice-modal" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Done</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold mb-4">Edit Stock</h3>
            <div class="space-y-4">
                <label class="block">
                    <span class="text-gray-500">Stock Code:</span>
                    <input type="text" id="edit-stock-code" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 input-style" readonly>
                </label>
                <label class="block">
                    <span class="text-gray-500">Product Name:</span>
                    <input type="text" id="edit-stock-name" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
                <label class="block">
                    <span class="text-gray-500">Quantity:</span>
                    <input type="number" id="edit-stock-quantity" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
                <label class="block">
                    <span class="text-gray-500">Price:</span>
                    <input type="number" id="edit-stock-price" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="edit-modal-save" class="px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">Save Changes</button>
                <button id="edit-modal-cancel" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Back</button>
            </div>
        </div>
    </div>

    <div id="return-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-xl w-full">
            <h3 class="text-2xl font-bold mb-4">Return Items for Invoice <span id="return-invoice-no"></span></h3>
            <div class="space-y-4">
                <p class="text-sm text-gray-500 italic">Adjust the quantity of items to be returned. Enter 0 for any item you do not wish to return.</p>
                <div class="overflow-y-auto max-h-80 card">
                    <table class="w-full text-left">
                        <thead class="table-header sticky top-0">
                            <tr>
                                <th class="p-2">Item</th>
                                <th class="p-2">Original Qty</th>
                                <th class="p-2">Return Qty</th>
                            </tr>
                        </thead>
                        <tbody id="return-item-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="return-modal-confirm" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600">Confirm Return</button>
                <button id="return-modal-cancel" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Cancel</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCOfYScRtu_r2p1MlDVGT_BSnR4VWe1kIU",
            authDomain: "villagefood-19f8a.firebaseapp.com",
            projectId: "villagefood-19f8a",
            storageBucket: "villagefood-19f8a.firebasestorage.app",
            messagingSenderId: "241737075683",
            appId: "1:241737075683:web:e3a7351cdbdbf77116aed6",
            measurementId: "G-1HH6F13ECS"
        };
        // Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Keys (for compatibility with original code)
        const STOCK_COLLECTION = 'stock';
        const SALES_COLLECTION = 'sales';
        const LOW_STOCK_THRESHOLD = 10;

        // Loader element
        const loader = document.getElementById('loader');
        const messageBar = document.getElementById('message-bar');

        // New Message Bar function
        function showMessage(message, type = 'success', duration = 3000) {
            messageBar.textContent = message;
            messageBar.className = ''; // Clear existing classes
            messageBar.classList.add('show', type);
            setTimeout(() => {
                messageBar.classList.remove('show');
            }, duration);
        }

        // --- Helper: Firestore wrappers ---
        async function getAllDocs(collectionName) {
            loader.classList.remove('hidden');
            try {
                const snaps = await getDocs(collection(db, collectionName));
                const data = [];
                snaps.forEach(s => data.push({ id: s.id, ...s.data() }));
                return data;
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function getDocById(collectionName, id) {
            loader.classList.remove('hidden');
            try {
                const dref = doc(db, collectionName, id);
                const snap = await getDoc(dref);
                return snap.exists() ? { id: snap.id, ...snap.data() } : null;
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function setDocById(collectionName, id, obj) {
            loader.classList.remove('hidden');
            try {
                await setDoc(doc(db, collectionName, id), obj);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function addDocAuto(collectionName, obj) {
            loader.classList.remove('hidden');
            try {
                return await addDoc(collection(db, collectionName), obj);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function updateDocById(collectionName, id, obj) {
            loader.classList.remove('hidden');
            try {
                await updateDoc(doc(db, collectionName, id), obj);
            } finally {
                loader.classList.add('hidden');
            }
        }

        async function deleteDocById(collectionName, id) {
            loader.classList.remove('hidden');
            try {
                await deleteDoc(doc(db, collectionName, id));
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- UI & State ---
        const sections = {
            dashboard: document.getElementById('dashboard'),
            stock: document.getElementById('stock'),
            invoice: document.getElementById('invoice'),
            sales: document.getElementById('sales')
        };
        const navBtns = document.querySelectorAll('.nav-btn');
        navBtns.forEach(btn => btn.addEventListener('click', async () => {
            const target = btn.dataset.target;
            for (const k in sections) sections[k].classList.remove('active');
            sections[target].classList.add('active');
            navBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (target === 'dashboard') await renderDashboard();
            if (target === 'stock') await renderStock();
            if (target === 'sales') await renderSales();
        }));
        document.querySelector('[data-target="dashboard"]').classList.add('active');

        // Theme toggle (unchanged)
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const setTheme = (theme) => {
            if (theme === 'dark') { document.body.classList.add('dark-mode'); sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden'); localStorage.setItem('theme','dark'); }
            else { document.body.classList.remove('dark-mode'); sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden'); localStorage.setItem('theme','light'); }
        };
        const toggleTheme = () => setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
        document.addEventListener('DOMContentLoaded', () => setTheme(localStorage.getItem('theme') || 'light'));
        themeToggleBtn.addEventListener('click', toggleTheme);

        // Utility
        const formatCurrency = (amount) => `₹${parseFloat(amount || 0).toFixed(2)}`;
        const generateInvoiceNo = () => `INV-${Date.now()}`;

        // --- Renderers and data operations now use async/await with Firestore ---

        async function renderDashboard() {
            loader.classList.remove('hidden');
            try {
                const stockData = await getAllDocs(STOCK_COLLECTION);
                const salesData = await getAllDocs(SALES_COLLECTION);

                let totalStockValue = 0;
                let totalSalesAmount = 0;
                const lowStockItems = [];
                stockData.forEach(item => { totalStockValue += (item.quantity || 0) * (item.price || 0); if ((item.quantity || 0) <= LOW_STOCK_THRESHOLD) lowStockItems.push(item); });
                salesData.forEach(s => totalSalesAmount += (s.totals && s.totals.grandTotal) ? s.totals.grandTotal : 0);

                document.getElementById('total-stock-value').textContent = formatCurrency(totalStockValue);
                document.getElementById('total-sales-amount').textContent = formatCurrency(totalSalesAmount);
                document.getElementById('low-stock-count').textContent = lowStockItems.length;
                document.getElementById('low-stock-count-list').textContent = lowStockItems.length;

                const lowStockTableBody = document.getElementById('low-stock-table-body');
                lowStockTableBody.innerHTML = '';
                if (lowStockItems.length === 0) {
                    lowStockTableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">No items are currently low in stock.</td></tr>';
                } else {
                    lowStockItems.forEach(item => {
                        const row = document.createElement('tr');
                        row.className = 'table-row';
                        row.innerHTML = `<td class="p-3 font-medium">${item.id}</td><td class="p-3">${item.name}</td><td class="p-3 text-red-500 font-semibold">${item.quantity}</td>`;
                        lowStockTableBody.appendChild(row);
                    });
                }
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Stock management
        let selectedStockIds = new Set();
        const stockListEl = document.getElementById('stock-list');

        async function renderStock() {
            loader.classList.remove('hidden');
            try {
                const stockData = await getAllDocs(STOCK_COLLECTION);
                stockListEl.innerHTML = '';
                selectedStockIds.clear();
                document.getElementById('select-all-stock').checked = false;

                if (stockData.length === 0) {
                    stockListEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No stock items found. Add some new products above.</td></tr>';
                    return;
                }

                stockData.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'table-row';
                    row.innerHTML = `
                        <td class="p-3"><input type="checkbox" data-id="${item.id}" class="stock-checkbox form-checkbox h-4 w-4 rounded-md"></td>
                        <td class="p-3 font-medium">${item.id}</td>
                        <td class="p-3">${item.name}</td>
                        <td class="p-3">${item.quantity}</td>
                        <td class="p-3">${formatCurrency(item.price)}</td>
                        <td class="p-3 space-x-2">
                            <button class="edit-stock-btn px-3 py-1 bg-yellow-500 text-white rounded-lg" data-id="${item.id}">Edit</button>
                            <button class="delete-stock-btn px-3 py-1 bg-red-500 text-white rounded-lg" data-id="${item.id}">Delete</button>
                        </td>
                    `;
                    stockListEl.appendChild(row);
                });
                stockListEl.querySelectorAll('.stock-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
                    const id = e.target.dataset.id;
                    if (e.target.checked) selectedStockIds.add(id); else selectedStockIds.delete(id);
                    document.getElementById('select-all-stock').checked = (selectedStockIds.size === stockData.length && stockData.length > 0);
                }));
                stockListEl.querySelectorAll('.edit-stock-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    const item = await getDocById(STOCK_COLLECTION, id);
                    if (item) openEditModal(item);
                }));
                stockListEl.querySelectorAll('.delete-stock-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    if (confirm('Delete this stock item?')) {
                        await deleteDocById(STOCK_COLLECTION, id);
                        await renderStock();
                        await renderDashboard();
                        showMessage('Stock item deleted.', 'success');
                    }
                }));
            } finally {
                loader.classList.add('hidden');
            }
        }

        document.getElementById('select-all-stock').addEventListener('change', async (e) => {
            const isChecked = e.target.checked;
            const stockData = await getAllDocs(STOCK_COLLECTION);
            stockListEl.querySelectorAll('.stock-checkbox').forEach(cb => { cb.checked = isChecked; const id=cb.dataset.id; if(isChecked) selectedStockIds.add(id); else selectedStockIds.delete(id); });
        });
        document.getElementById('btn-add-stock').addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                const stockCode = document.getElementById('add-stock-code').value.trim();
                const name = document.getElementById('add-stock-name').value.trim();
                const price = parseFloat(document.getElementById('add-stock-price').value);
                const quantity = parseInt(document.getElementById('add-stock-quantity').value,10);
                if (stockCode && name && !isNaN(price) && !isNaN(quantity) && quantity >= 0) {
                    const existing = await getDocById(STOCK_COLLECTION, stockCode);
                    if (existing) {
                        showMessage('Stock code exists. Use edit to update.', 'error');
                        return;
                    }
                    const item = { id: stockCode, name, price, quantity };
                    await setDocById(STOCK_COLLECTION, stockCode, item);
                    showMessage('Stock item added successfully!', 'success');
                    document.getElementById('add-stock-code').value=''; document.getElementById('add-stock-name').value='';
                    document.getElementById('add-stock-price').value=''; document.getElementById('add-stock-quantity').value='';
                    await renderStock(); await renderDashboard();
                } else { showMessage('Please fill out all fields correctly.', 'error'); }
            } finally {
                loader.classList.add('hidden');
            }
        });

        document.getElementById('btn-delete-selected').addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                if (selectedStockIds.size===0) { showMessage('Select at least one item to delete.', 'error'); return; }
                if (!confirm('Delete selected items?')) {
                     loader.classList.add('hidden'); // Hide loader if user cancels confirm
                    return;
                }
                for (const id of selectedStockIds) { await deleteDocById(STOCK_COLLECTION, id); }
                selectedStockIds.clear(); await renderStock(); await renderDashboard();
                showMessage('Selected items deleted.', 'success');
            } finally {
                loader.classList.add('hidden');
            }
        });
        // Edit modal logic
        const editModal = document.getElementById('edit-modal');
        let currentEditingId = null;
        function openEditModal(item) {
            currentEditingId = item.id;
            document.getElementById('edit-stock-code').value = item.id;
            document.getElementById('edit-stock-name').value = item.name;
            document.getElementById('edit-stock-quantity').value = item.quantity;
            document.getElementById('edit-stock-price').value = item.price;
            editModal.classList.remove('hidden');
        }
        document.getElementById('edit-modal-save').addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                const id = currentEditingId;
                const name = document.getElementById('edit-stock-name').value.trim();
                const quantity = parseInt(document.getElementById('edit-stock-quantity').value,10);
                const price = parseFloat(document.getElementById('edit-stock-price').value);
                if (name && !isNaN(quantity) && !isNaN(price) && quantity >= 0) {
                    await setDocById(STOCK_COLLECTION, id, { id, name, quantity, price });
                    showMessage('Stock item updated successfully!', 'success'); editModal.classList.add('hidden'); await renderStock(); await renderDashboard();
                } else { showMessage('Please fill all fields correctly.', 'error'); }
            } finally {
                loader.classList.add('hidden');
            }
        });
        document.getElementById('edit-modal-cancel').addEventListener('click', () => editModal.classList.add('hidden'));

        // CSV import/export (reads file and writes to Firestore)
        const csvFileInput = document.getElementById('csv-file-input');
        document.getElementById('btn-import-csv').addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', async (event) => {
            loader.classList.remove('hidden');
            try {
                const file = event.target.files[0]; if(!file) return;
                const text = await file.text();
                const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0);
                if (rows.length<=1) { showMessage('CSV file is empty or contains only headers.', 'error'); return; }
                for (let i=1;i<rows.length;i++){
                    const [stockCode,name,price,quantity] = rows[i].split(',').map(x=>x.trim());
                    if (stockCode && name && !isNaN(parseFloat(price)) && !isNaN(parseInt(quantity,10)) && parseInt(quantity, 10) >= 0) {
                        await setDocById(STOCK_COLLECTION, stockCode, { id: stockCode, name, price: parseFloat(price), quantity: parseInt(quantity,10) });
                    }
                }
                showMessage('Stock data imported successfully!', 'success'); await renderStock(); await renderDashboard();
            } finally {
                loader.classList.add('hidden');
            }
        });
        document.getElementById('btn-export-csv').addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                const stockData = await getAllDocs(STOCK_COLLECTION);
                if (stockData.length===0) { showMessage('No data to export.', 'warning'); return; }
                const headers = ['Stock Code','Name','Quantity','Price'];
                const csv = [headers.join(','), ...stockData.map(i=>`${i.id},"${i.name}",${i.quantity},${i.price}`)].join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'stock_data.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            } finally {
                loader.classList.add('hidden');
            }
        });
        document.getElementById('btn-export-pdf').addEventListener('click', () => showMessage('PDF export requires a library like jsPDF (not included).', 'warning'));

        // --- Invoice logic ---
        const stockCodeInput = document.getElementById('stock-code-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const invoiceItemListEl = document.getElementById('invoice-item-list');
        const savePrintBtn = document.getElementById('save-print-btn');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceBillContent = document.getElementById('invoice-bill-content');

        let invoiceItems = [];
        stockCodeInput.addEventListener('keydown', (e)=>{ if(e.key==='Tab'){ e.preventDefault(); addItemBtn.click(); } });

        addItemBtn.addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                const stockCode = stockCodeInput.value.trim(); if(!stockCode){ showMessage('Please enter a stock code.', 'error'); return; }
                const stockItem = await getDocById(STOCK_COLLECTION, stockCode);
                if (!stockItem) { showMessage('Stock code not found.', 'error'); return; }
                if (stockItem.quantity < 1) { showMessage('This item is out of stock.', 'warning'); return; }
                const existing = invoiceItems.find(it => it.id === stockCode);
                if (existing) { showMessage('Item already added to the invoice.', 'warning'); stockCodeInput.value=''; return; }
                invoiceItems.push({ id: stockItem.id, name: stockItem.name, price: stockItem.price, quantity: 1, discount:0, gst:18 });
                renderInvoiceItems(); updateInvoiceTotals(); stockCodeInput.value='';
            } finally {
                loader.classList.add('hidden');
            }
        });
        function renderInvoiceItems(){
            invoiceItemListEl.innerHTML='';
            if (invoiceItems.length===0) { invoiceItemListEl.innerHTML='<tr><td colspan="7" class="p-4 text-center text-gray-400">No items added to invoice.</td></tr>'; return; }
            invoiceItems.forEach((item,index)=>{
                const total = (item.quantity * item.price) * (1 - item.discount / 100) * (1 + item.gst / 100);
                const row = document.createElement('tr'); row.className='table-row';
                row.innerHTML = `
                    <td class="p-3 font-medium">${item.name}</td>
                    <td class="p-3">${formatCurrency(item.price)}</td>
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <button class="qty-dec px-2 py-1 rounded-md" data-index="${index}">-</button>
                            <input type="number" value="${item.quantity}" min="1" class="w-16 text-center border rounded-md p-1 quantity-input" data-index="${index}">
                            <button class="qty-inc px-2 py-1 rounded-md" data-index="${index}">+</button>
                        </div>
                    </td>
                    <td class="p-3"><input type="number" value="${item.discount}" min="0" max="100" class="w-16 border rounded-md p-1" data-index="${index}" data-field="discount"></td>
                    <td class="p-3 text-gray-500">${item.gst}%</td>
                    <td class="p-3 font-semibold">${formatCurrency(total)}</td>
                    <td class="p-3"><button class="remove-item-btn text-red-500" data-index="${index}">x</button></td>
                `;
                invoiceItemListEl.appendChild(row);
            });

            invoiceItemListEl.querySelectorAll('.qty-inc').forEach(btn=>btn.addEventListener('click', async (e)=>{ const index = parseInt(e.target.dataset.index); const stockItem = await getDocById(STOCK_COLLECTION, invoiceItems[index].id); if(invoiceItems[index].quantity < (stockItem ? stockItem.quantity : invoiceItems[index].quantity)){ invoiceItems[index].quantity++; renderInvoiceItems(); updateInvoiceTotals(); } else showMessage('Cannot exceed available stock.', 'warning'); }));
            invoiceItemListEl.querySelectorAll('.qty-dec').forEach(btn=>btn.addEventListener('click',(e)=>{ const index=parseInt(e.target.dataset.index); if(invoiceItems[index].quantity>1){ invoiceItems[index].quantity--; renderInvoiceItems(); updateInvoiceTotals(); } }));
            invoiceItemListEl.querySelectorAll('input[data-field]').forEach(input=>input.addEventListener('input',(e)=>{ const index=parseInt(e.target.dataset.index); const field=e.target.dataset.field; let val=parseFloat(e.target.value); if(field==='discount'){ if(val<0) val=0; if(val>100) val=100; invoiceItems[index].discount=val; } renderInvoiceItems(); updateInvoiceTotals(); }));
            invoiceItemListEl.querySelectorAll('.quantity-input').forEach(inp=>inp.addEventListener('input', async (e)=>{ const index=parseInt(e.target.dataset.index); let val=parseInt(e.target.value,10); if(isNaN(val)||val<1) val=1; const stockItem = await getDocById(STOCK_COLLECTION, invoiceItems[index].id); if(stockItem && val > stockItem.quantity){ showMessage('Cannot exceed available stock.', 'warning'); val = stockItem.quantity; e.target.value = val; } invoiceItems[index].quantity=val; renderInvoiceItems(); updateInvoiceTotals(); }));
            invoiceItemListEl.querySelectorAll('.remove-item-btn').forEach(btn=>btn.addEventListener('click',(e)=>{ const index=parseInt(e.target.dataset.index); invoiceItems.splice(index,1); renderInvoiceItems(); updateInvoiceTotals(); }));
        }

        function updateInvoiceTotals(){
            let subtotal=0,totalDiscount=0,totalGST=0, grandTotal=0;
            invoiceItems.forEach(item=>{ 
                const itemSubtotal = item.price * item.quantity; 
                const itemDiscount = itemSubtotal * (item.discount / 100); 
                const itemTotalAfterDiscount = itemSubtotal - itemDiscount; 
                const itemGST = itemTotalAfterDiscount * (item.gst / 100); 
                subtotal += itemSubtotal; 
                totalDiscount += itemDiscount; 
                totalGST += itemGST;
                grandTotal += itemTotalAfterDiscount + itemGST;
            });
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('total-discount').textContent = formatCurrency(totalDiscount);
            document.getElementById('total-gst').textContent = formatCurrency(totalGST);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0; 
            document.getElementById('balance').value = (paidAmount - grandTotal).toFixed(2);
        }

        document.getElementById('paid-amount').addEventListener('input', updateInvoiceTotals);
        // Save invoice -> store in Firestore sales and decrement stock quantities
        document.getElementById('save-print-btn').addEventListener('click', async () => {
            loader.classList.remove('hidden');
            try {
                if (invoiceItems.length===0) { showMessage('Please add at least one item to the invoice.', 'error'); return; }
                const invoiceNo = document.getElementById('invoice-no').value || generateInvoiceNo();
                const invoiceDate = document.getElementById('invoice-date').value || new Date().toISOString().slice(0,10);
                const customerName = document.getElementById('customer-name').value;
                const customerPhone = document.getElementById('customer-phone').value;
                const customerEmail = document.getElementById('customer-email').value;
                const customerAddress = document.getElementById('customer-address').value;
                const paymentMode = document.getElementById('payment-mode').value;
                const paidAmount = parseFloat(document.getElementById('paid-amount').value) || 0;
                const balance = parseFloat(document.getElementById('balance').value) || 0;

                // Calculate totals
                let totals = { subtotal: 0, discount: 0, gst: 0, grandTotal: 0 };
                invoiceItems.forEach(it => {
                    const itemSubtotal = it.price * it.quantity;
                    const itemDiscount = itemSubtotal * (it.discount / 100);
                    const afterDiscount = itemSubtotal - itemDiscount;
                    const itemGST = afterDiscount * (it.gst / 100);

                    totals.subtotal += itemSubtotal;
                    totals.discount += itemDiscount;
                    totals.gst += itemGST;
                    totals.grandTotal += afterDiscount + itemGST;
                });

                const invoiceData = { 
                    invoiceNo, 
                    invoiceDate, 
                    customer: {name: customerName, phone: customerPhone, email: customerEmail, address: customerAddress}, 
                    items: invoiceItems, 
                    paymentMode, 
                    paidAmount, 
                    balance, 
                    totals, 
                    timestamp: Date.now(), 
                    returned: false 
                };
                
                await setDocById(SALES_COLLECTION, invoiceNo, invoiceData);

                // Update stock quantities
                for(const it of invoiceItems){
                    const stock = await getDocById(STOCK_COLLECTION, it.id);
                    if(stock){
                        await updateDocById(STOCK_COLLECTION, it.id, { quantity: stock.quantity - it.quantity });
                    }
                }
                
                showMessage('Invoice saved successfully!', 'success');
                await renderSales(); 
                await renderStock(); 
                await renderDashboard();

                // Show invoice bill modal
                const invoiceHtml = `
                    <h2 class="text-xl font-bold mb-4">Invoice ${invoiceNo}</h2>
                    <div class="space-y-2 text-sm">
                        <p><strong>Date:</strong> ${new Date(invoiceData.timestamp).toLocaleString()}</p>
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Phone:</strong> ${customerPhone}</p>
                        <p><strong>Address:</strong> ${customerAddress}</p>
                    </div>
                    <hr class="my-4">
                    <table class="w-full text-left table-auto">
                        <thead>
                            <tr class="font-bold">
                                <th class="p-2">Item</th>
                                <th class="p-2">Qty</th>
                                <th class="p-2">Price</th>
                                <th class="p-2">Disc.</th>
                                <th class="p-2">GST</th>
                                <th class="p-2 text-right">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${invoiceItems.map(item => `
                                <tr>
                                    <td class="p-2">${item.name}</td>
                                    <td class="p-2">${item.quantity}</td>
                                    <td class="p-2">${formatCurrency(item.price)}</td>
                                    <td class="p-2">${item.discount}%</td>
                                    <td class="p-2">${item.gst}%</td>
                                    <td class="p-2 text-right">${formatCurrency((item.price * item.quantity) * (1 - item.discount / 100) * (1 + item.gst / 100))}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <hr class="my-4">
                    <div class="text-right space-y-1">
                        <p>Subtotal: ${formatCurrency(totals.subtotal)}</p>
                        <p>Total Discount: ${formatCurrency(totals.discount)}</p>
                        <p>Total GST: ${formatCurrency(totals.gst)}</p>
                        <p class="text-2xl font-bold">Grand Total: ${formatCurrency(totals.grandTotal)}</p>
                        <p>Paid: ${formatCurrency(paidAmount)}</p>
                        <p>Balance: ${formatCurrency(balance)}</p>
                    </div>
                `;
                invoiceBillContent.innerHTML = invoiceHtml;
                invoiceModal.classList.remove('hidden');
                invoiceItems = [];
                renderInvoiceItems(); 
                document.getElementById('invoice-no').value = generateInvoiceNo();
                document.getElementById('invoice-date').value = new Date().toISOString().slice(0, 10);
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('customer-email').value = '';
                document.getElementById('customer-address').value = '';
                document.getElementById('paid-amount').value = '';
                updateInvoiceTotals();
            } finally {
                loader.classList.add('hidden');
            }
        });

        document.getElementById('close-invoice-modal').addEventListener('click',()=>invoiceModal.classList.add('hidden'));

        // --- Sales rendering ---
        async function renderSales(){
            loader.classList.remove('hidden');
            try {
                const sales = await getAllDocs(SALES_COLLECTION);
                const salesListEl = document.getElementById('sales-list');
                salesListEl.innerHTML='';
                if(sales.length===0){ salesListEl.innerHTML='<tr><td colspan="6" class="p-4 text-center text-gray-400">No sales recorded.</td></tr>'; return; }
                
                const sortedSales = sales.sort((a,b) => b.timestamp - a.timestamp);

                sortedSales.forEach(sale=>{
                    const row=document.createElement('tr');
                    row.innerHTML=`
                        <td class="p-3">${new Date(sale.timestamp).toLocaleString()}</td>
                        <td class="p-3">${sale.invoiceNo}</td>
                        <td class="p-3">${sale.customer.name}</td>
                        <td class="p-3">${formatCurrency(sale.totals.grandTotal)}</td>
                        <td class="p-3">${sale.returned ? 'Returned' : 'OK'}</td>
                        <td class="p-3 text-center space-x-2">
                            <button class="view-invoice-btn px-3 py-1 bg-indigo-500 text-white rounded-lg" data-id="${sale.invoiceNo}">View</button>
                            ${!sale.returned ? `<button class="return-invoice-btn px-3 py-1 bg-red-500 text-white rounded-lg" data-id="${sale.invoiceNo}">Return</button>` : ''}
                        </td>`;
                    salesListEl.appendChild(row);
                });
                salesListEl.querySelectorAll('.view-invoice-btn').forEach(btn=>btn.addEventListener('click',async e=>{
                    loader.classList.remove('hidden');
                    try {
                        const id=e.target.dataset.id; const sale=await getDocById(SALES_COLLECTION,id);
                        if(sale){ 
                            const invoiceHtml = `
                                <h2 class="text-xl font-bold mb-4">Invoice ${sale.invoiceNo}</h2>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Date:</strong> ${new Date(sale.timestamp).toLocaleString()}</p>
                                    <p><strong>Customer:</strong> ${sale.customer.name}</p>
                                    <p><strong>Phone:</strong> ${sale.customer.phone}</p>
                                    <p><strong>Address:</strong> ${sale.customer.address}</p>
                                </div>
                                <hr class="my-4">
                                <table class="w-full text-left table-auto">
                                    <thead>
                                        <tr class="font-bold">
                                            <th class="p-2">Item</th>
                                            <th class="p-2">Qty</th>
                                            <th class="p-2">Price</th>
                                            <th class="p-2">Disc.</th>
                                            <th class="p-2">GST</th>
                                            <th class="p-2 text-right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sale.items.map(item => `
                                            <tr>
                                                <td class="p-2">${item.name}</td>
                                                <td class="p-2">${item.quantity}</td>
                                                <td class="p-2">${formatCurrency(item.price)}</td>
                                                <td class="p-2">${item.discount}%</td>
                                                <td class="p-2">${item.gst}%</td>
                                                <td class="p-2 text-right">${formatCurrency((item.price * item.quantity) * (1 - item.discount / 100) * (1 + item.gst / 100))}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                                <hr class="my-4">
                                <div class="text-right space-y-1">
                                    <p>Subtotal: ${formatCurrency(sale.totals.subtotal)}</p>
                                    <p>Total Discount: ${formatCurrency(sale.totals.discount)}</p>
                                    <p>Total GST: ${formatCurrency(sale.totals.gst)}</p>
                                    <p class="text-2xl font-bold">Grand Total: ${formatCurrency(sale.totals.grandTotal)}</p>
                                    <p>Paid: ${formatCurrency(sale.paidAmount)}</p>
                                    <p>Balance: ${formatCurrency(sale.balance)}</p>
                                </div>
                            `;
                            invoiceBillContent.innerHTML = invoiceHtml;
                            invoiceModal.classList.remove('hidden'); 
                        }
                    } finally {
                        loader.classList.add('hidden');
                    }
                }));
                salesListEl.querySelectorAll('.return-invoice-btn').forEach(btn=>btn.addEventListener('click',async e=>{
                    loader.classList.remove('hidden');
                    try {
                        const id=e.target.dataset.id; const sale=await getDocById(SALES_COLLECTION,id);
                        if(!sale) return; if(sale.returned){ showMessage('This invoice has already been returned.', 'warning'); return; }
                        const returnModal = document.getElementById('return-modal');
                        const returnItemListEl = document.getElementById('return-item-list');
                        const returnInvoiceNoEl = document.getElementById('return-invoice-no');
                        
                        returnInvoiceNoEl.textContent = id;
                        returnItemListEl.innerHTML = '';

                        sale.items.forEach(item => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="p-2">${item.name}</td>
                                <td class="p-2">${item.quantity}</td>
                                <td class="p-2">
                                    <input type="number" min="0" max="${item.quantity}" value="${item.quantity}" data-id="${item.id}" class="w-20 border rounded-md p-1 return-qty-input">
                                </td>
                            `;
                            returnItemListEl.appendChild(row);
                        });
                        returnModal.classList.remove('hidden');
                        loader.classList.add('hidden'); // Hide loader while user is interacting with modal

                        document.getElementById('return-modal-confirm').onclick = async () => {
                            loader.classList.remove('hidden');
                            try {
                                const returnItems = Array.from(returnItemListEl.querySelectorAll('.return-qty-input')).map(input => ({
                                    id: input.dataset.id,
                                    quantity: parseInt(input.value, 10)
                                }));
                                
                                for(const item of returnItems) {
                                    if (item.quantity > 0) {
                                        const stock = await getDocById(STOCK_COLLECTION, item.id);
                                        if (stock) {
                                            await updateDocById(STOCK_COLLECTION, item.id, { quantity: stock.quantity + item.quantity });
                                        }
                                    }
                                }

                                await updateDocById(SALES_COLLECTION, id, { ...sale, returned: true });
                                showMessage('Return processed successfully!', 'success');
                                returnModal.classList.add('hidden');
                                await renderSales();
                                await renderStock();
                                await renderDashboard();
                            } finally {
                                loader.classList.add('hidden');
                            }
                        };

                        document.getElementById('return-modal-cancel').onclick = () => returnModal.classList.add('hidden');
                    } finally {
                        // This finally block is for the button click itself, not the modal interaction
                        // Loader is managed within the inner async function
                    }
                }));
            } finally {
                loader.classList.add('hidden');
            }
        }

        // Init: render dashboard on load
        document.addEventListener('DOMContentLoaded', async () => { 
            loader.classList.remove('hidden');
            try {
                await renderDashboard();
                document.getElementById('invoice-no').value = generateInvoiceNo();
                document.getElementById('invoice-date').value = new Date().toISOString().slice(0, 10);
                renderInvoiceItems(); // Initialize invoice item list
            } finally {
                loader.classList.add('hidden');
            }
        });
    </script>
</body>
</html>