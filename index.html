<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJ SMART APPS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        /* New Color variables for both themes */
        :root {
            --color-bg: #f5f7fa;
            --color-card: #ffffff;
            --color-primary: #3498db;
            --color-primary-dark: #2980b9;
            --color-accent: #2ecc71;
            --color-accent-dark: #27ae60;
            --color-text-main: #2c3e50;
            --color-text-secondary: #7f8c8d;
            --color-border: #e4e7ea;
            --color-input: #f8f9fa;
            --color-table-header: #ecf0f1;
            --color-table-row-hover: #fcfcfc;
            --color-danger: #e74c3c;
            --color-success: #2ecc71;
            --color-warning: #f39c12;
        }
        .dark-mode {
            --color-bg: #1a1e24;
            --color-card: #2c323a;
            --color-primary: #3498db;
            --color-primary-dark: #2980b9;
            --color-accent: #2ecc71;
            --color-accent-dark: #27ae60;
            --color-text-main: #ecf0f1;
            --color-text-secondary: #bdc3c7;
            --color-border: #4d565e;
            --color-input: #3b424d;
            --color-table-header: #3b424d;
            --color-table-row-hover: #4d565e;
            --color-danger: #e74c3c;
            --color-success: #2ecc71;
            --color-warning: #f39c12;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-main);
            transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 1200px; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .card { background-color: var(--color-card); border: 1px solid var(--color-border); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .nav-btn { background-color: transparent; color: var(--color-text-secondary); }
        .nav-btn.active, .nav-btn:hover { background-color: var(--color-border); color: var(--color-primary); }
        .dark-mode .nav-btn.active, .dark-mode .nav-btn:hover { background-color: var(--color-border); color: var(--color-accent); }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .input-style { background-color: var(--color-input); border-color: var(--color-border); color: var(--color-text-main); }
        .table-header { background-color: var(--color-table-header); }
        .table-row:hover { background-color: var(--color-table-row-hover); }

        /* Loader container - centered */
        .loader-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        /* Dark mode */
        .dark-mode .loader-container {
            background-color: rgba(0, 0, 0, 0.8);
        }

        /* Hidden by default */
        .loader-container.hidden {
            display: none;
        }

        /* New Loader Animation */
        .loader {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            border: 3px solid;
            border-color: #f39c12 #e74c3c #2ecc71 #3498db;
            box-sizing: border-box;
            animation: rotation 1.5s linear infinite;
        }

        .loader::after {
            content: '';
            box-sizing: border-box;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 3px solid;
            border-color: #2ecc71 #3498db #f39c12 #e74c3c;
            animation: rotationBack 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes rotationBack {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(-360deg); }
        }
        
        /* Loader text animation */
.loader-text {
    font-size: 32px;
    font-weight: 700;
    display: flex;
    gap: 5px;
    margin-top: 15px;
    font-family: 'Inter', sans-serif;
    text-transform: uppercase;
}

/* Animate letters */
.loader-text span {
    display: inline-block;
    animation: fadeAndMove 1.5s ease-in-out infinite;
    opacity: 0;
}

/* Different colors for each letter */
.loader-text span:nth-child(1) { color: #ff4757; animation-delay: 0s; }     /* Red */
.loader-text span:nth-child(2) { color: #ffa502; animation-delay: 0.1s; }  /* Orange */
.loader-text span:nth-child(3) { color: #2ed573; animation-delay: 0.2s; }  /* Green */
.loader-text span:nth-child(4) { color: #1e90ff; animation-delay: 0.3s; }  /* Blue */
.loader-text span:nth-child(5) { color: #3742fa; animation-delay: 0.4s; }  /* Indigo */
.loader-text span:nth-child(6) { color: #a55eea; animation-delay: 0.5s; }  /* Purple */
.loader-text span:nth-child(7) { color: #ff6b81; animation-delay: 0.6s; }  /* Pink */
.loader-text span:nth-child(8) { color: #70a1ff; animation-delay: 0.7s; }  /* Light Blue */
.loader-text span:nth-child(9) { color: #2ed573; animation-delay: 0.8s; }  /* Green */
.loader-text span:nth-child(10) { color: #ffa502; animation-delay: 0.9s; } /* Orange */
.loader-text span:nth-child(11) { color: #ff4757; animation-delay: 1s; }   /* Red */
.loader-text span:nth-child(12) { color: #3742fa; animation-delay: 1.1s; } /* Indigo */
.loader-text span:nth-child(13) { color: #a55eea; animation-delay: 1.2s; } /* Purple */

/* Animation effect */
@keyframes fadeAndMove {
    0%, 100% { transform: translateY(0); opacity: 1; }
    50% { transform: translateY(-10px); opacity: 0.5; }
}

        /* Custom Alert */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 9999px;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, top 0.5s ease-in-out;
            pointer-events: none;
            color: white;
        }
        .custom-alert.visible {
            opacity: 1;
            top: 20px;
        }
        .custom-alert.success { background-color: var(--color-success); }
        .custom-alert.error { background-color: var(--color-danger); }
        .custom-alert.info { background-color: var(--color-primary); }
        
        /* Print Styles */
        @media print {
            @page {
                size: 430mm 932mm; /* Custom paper size */
            }
            body > *:not(#invoice-modal) {
                display: none;
            }
            #invoice-modal {
                position: static !important;
                transform: none !important;
                background-color: white;
            }
            /* Hide the 'Print' and 'Done' buttons only when printing */
            .no-print {
                display: none;
            }
            .card.p-8.rounded-lg.shadow-2xl.max-w-2xl.w-full {
                box-shadow: none;
            }
            #invoice-bill-content {
                border: none !important;
            }
            .qr-code-container {
                display: block;
            }
        }

        .qr-code-container {
            display: none;
            text-align: center;
            margin-top: 20px;
        }
    </style>

<div class="ad-panel-horizontal">
    <div class="ad-slider-full-width"></div>
</div>

<style>
/* Full-width ad slider container */
.ad-panel-horizontal {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    overflow: hidden;
    width: 100vw; /* Using viewport width to ensure full-screen fit */
    position: relative;
    height: 180px;
}

/* Updated slider container */
.ad-slider-full-width {
    display: flex;
    transition: transform 0.5s ease-in-out;
    width: 100%;
    height: 100%;
}

/* Each slide takes up the full viewport width */
.ad-slide-full-width {
    flex-shrink: 0;
    width: 100vw; /* Each slide is now viewport-wide */
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
}

.ad-slide-full-width img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

@media (max-width: 480px) {
    .ad-panel-horizontal {
        height: 120px;
    }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyCOfYScRtu_r2p1MlDVGT_BSnR4VWe1kIU",
    authDomain: "villagefood-19f8a.firebaseapp.com",
    projectId: "villagefood-19f8a",
    storageBucket: "villagefood-19f8a.appspot.com",
    messagingSenderId: "241737075683",
    appId: "1:241737075683:web:e3a7351cdbdbf77116aed6",
    measurementId: "G-1HH6F13ECS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const adDocRef = doc(db, "advertisements", "currentAd");
const slider = document.querySelector('.ad-slider-full-width');
const adPanel = document.querySelector('.ad-panel-horizontal');

let adImages = [];
let currentIndex = 0;
let sliderInterval;

function renderSlides() {
    slider.innerHTML = "";

    if (adImages.length === 0) {
        adPanel.style.display = "none"; // Hide panel when no ads
        return;
    }

    adPanel.style.display = "flex"; // Show panel when ads exist

    adImages.forEach(url => {
        const slide = document.createElement("div");
        slide.className = "ad-slide-full-width";

        const img = document.createElement("img");
        img.src = url;
        img.alt = "Ad";

        slide.appendChild(img);
        slider.appendChild(slide);
    });

    currentIndex = 0;
    slider.style.transform = `translateX(0)`;
}

function showNextSlide() {
    if (adImages.length === 0) return;
    currentIndex = (currentIndex + 1) % adImages.length;
    slider.style.transform = `translateX(-${currentIndex * 100}vw)`;
}

function startSlider() {
    if (sliderInterval) clearInterval(sliderInterval);
    sliderInterval = setInterval(showNextSlide, 3000);
}

onSnapshot(adDocRef, (docSnap) => {
    if (!docSnap.exists()) {
        adPanel.style.display = "none"; // Hide if doc not found
        return;
    }
    const data = docSnap.data();
    adImages = (data.images || []).filter(url => url);
    renderSlides();
    startSlider();
});
</script>

</head>
<body class="min-h-screen flex flex-col">

    <div id="loader" class="loader-container hidden">
        <div class="loader"></div>
        <div class="loader-text">
            <span>M</span>
            <span>J</span>
            <span> </span>
            <span>S</span>
            <span>M</span>
            <span>A</span>
	    <span>R</span>
            <span>T</span>
            <span> </span>
            <span>A</span>
            <span>P</span>
            <span>P</span>
	    <span>S</span>
        </div>
    </div>

    <div id="custom-alert" class="custom-alert hidden"></div>

    <header class="w-full bg-gradient-to-r from-orange-500 via-orange-400 to-orange-300 text-white shadow-lg">
  <div class="container mx-auto max-w-screen-2xl flex flex-col sm:flex-row items-center justify-between min-h-24 px-6 lg:px-12 py-4">
    
    <!-- Store Title + Tagline -->
    <div class="flex flex-col items-center sm:items-start text-center sm:text-left">
      <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-wide drop-shadow-lg uppercase font-sans">
        MULLAI STORE
      </h1>
      <span class="text-xs sm:text-sm md:text-base font-medium tracking-widest text-white/90 uppercase font-sans">
        DESIGNED BY MJ SMART APPS
      </span>
    </div>

    <!-- Navigation -->
    <nav class="flex flex-wrap items-center justify-center sm:justify-end gap-3 mt-4 sm:mt-0">
      <button data-target="dashboard" class="nav-btn px-5 py-2 sm:px-6 sm:py-3 rounded-full bg-orange-600 hover:bg-orange-500 shadow-md transition-all duration-300 transform hover:-translate-y-1 hover:scale-105">Dashboard</button>
      <button data-target="stock" class="nav-btn px-5 py-2 sm:px-6 sm:py-3 rounded-full bg-orange-500 hover:bg-orange-400 shadow-md transition-all duration-300 transform hover:-translate-y-1 hover:scale-105">Stock Management</button>
      <button data-target="invoice" class="nav-btn px-5 py-2 sm:px-6 sm:py-3 rounded-full bg-orange-400 hover:bg-orange-300 shadow-md transition-all duration-300 transform hover:-translate-y-1 hover:scale-105">Invoice</button>
      <button data-target="sales" class="nav-btn px-5 py-2 sm:px-6 sm:py-3 rounded-full bg-orange-500 hover:bg-orange-400 shadow-md transition-all duration-300 transform hover:-translate-y-1 hover:scale-105">Sales Details</button>

      <!-- Theme Toggle -->
      <button id="theme-toggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 shadow-md hover:shadow-lg transition duration-300">
        <svg id="sun-icon" class="w-6 h-6 text-yellow-400 hidden" fill="currentColor" viewBox="0 0 20 20">
          <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 11a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-4-4a5 5 0 100 10 5 5 0 000-10zM4 13a1 1 0 01-1 1H2a1 1 0 110-2h1a1 1 0 011 1zm12-2a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zm-1-6a1 1 0 010-2l.707-.707a1 1 0 011.414 0l.707.707a1 1 0 010 1.414L16.707 6a1 1 0 01-1.414 0L15 5.293zM5.293 6L4.586 5.293a1 1 0 010-1.414l.707-.707a1 1 0 111.414 1.414L5.293 6zM15 15a1 1 0 01-1 1h-1a1 1 0 110-2h1a1 1 0 011 1zm-6-2a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1z"/>
        </svg>
        <svg id="moon-icon" class="w-6 h-6 text-gray-800" fill="currentColor" viewBox="0 0 20 20">
          <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
        </svg>
      </button>

      <!-- Ads Toggle -->
      <div class="flex items-center space-x-2">
        <span class="font-medium text-white">Ads</span>
        <div id="adsToggleSwitch" class="toggle-switch relative w-14 h-7 rounded-full cursor-pointer bg-gray-400 transition-colors duration-300" data-enabled="false">
          <div class="switch-handle absolute left-1 top-1 w-5 h-5 bg-white rounded-full shadow-md transition-transform duration-300"></div>
        </div>
      </div>
    </nav>
  </div>
</header>



<!-- Fullscreen Ad Popup -->
<div id="adPopup" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col justify-center items-center hidden z-50 p-4">
  <div class="relative w-full h-full flex flex-col justify-center items-center">
    <button id="closeAdPopup" class="absolute top-4 right-4 text-white text-3xl font-bold z-50">&times;</button>
    <h2 id="adMessage" class="text-2xl md:text-4xl font-bold text-white text-center mb-6 px-4"></h2>
    <img id="adImage" class="rounded-xl shadow-lg" style="max-width:90vw; max-height:70vh; object-fit:contain;" src="" alt="Advertisement">
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCOfYScRtu_r2p1MlDVGT_BSnR4VWe1kIU",
  authDomain: "villagefood-19f8a.firebaseapp.com",
  projectId: "villagefood-19f8a",
  storageBucket: "villagefood-19f8a.appspot.com",
  messagingSenderId: "241737075683",
  appId: "1:241737075683:web:e3a7351cdbdbf77116aed6",
  measurementId: "G-1HH6F13ECS"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const adDocRef = doc(db, "advertisements", "currentAd");

const adsToggleSwitch = document.getElementById("adsToggleSwitch");
const switchHandle = adsToggleSwitch.querySelector(".switch-handle");

const adPopup = document.getElementById("adPopup");
const adMessage = document.getElementById("adMessage");
const adImage = document.getElementById("adImage");

let imageList = [];
let currentIndex = 0;
let slideshowInterval;
let adsEnabled = false; // default OFF

// Update toggle UI
function setSwitchUI(enabled) {
  adsToggleSwitch.classList.toggle("bg-blue-500", enabled);
  switchHandle.style.transform = enabled ? "translateX(24px)" : "translateX(0)";
}

// Show/hide ad popup
function showAd() {
  if (!adsEnabled || imageList.length === 0) return;
  adPopup.classList.remove("hidden");
  currentIndex = 0;
  adImage.src = imageList[currentIndex];
  if (slideshowInterval) clearInterval(slideshowInterval);
  slideshowInterval = setInterval(() => {
    currentIndex = (currentIndex + 1) % imageList.length;
    adImage.src = imageList[currentIndex];
  }, 2000);
}

function hideAd() {
  adPopup.classList.add("hidden");
  if (slideshowInterval) clearInterval(slideshowInterval);
}

// Listen for changes in Firebase
onSnapshot(adDocRef, (snap) => {
  if (!snap.exists()) return;
  const data = snap.data();

  imageList = data.images || [];
  adMessage.textContent = data.message || "";
  adsEnabled = data.adsEnabled ?? false; // default OFF
  setSwitchUI(adsEnabled);

  if (adsEnabled) showAd();
  else hideAd();
});

// Handle user toggle
adsToggleSwitch.addEventListener("click", async () => {
  adsEnabled = !adsEnabled;
  setSwitchUI(adsEnabled);
  if (!adsEnabled) hideAd();
  else showAd();

  try {
    await updateDoc(adDocRef, { adsEnabled });
    console.log("User toggle saved:", adsEnabled);
  } catch (err) {
    console.error("Failed to save toggle:", err);
  }
});

// Close popup
document.getElementById("closeAdPopup").addEventListener("click", hideAd);
</script>

<style>
/* Toggle container */
.toggle-switch {
  width: 3rem;
  height: 1.5rem;
  border-radius: 9999px;
  background-color: #ccc; /* OFF: light gray */
  position: relative;
  transition: background-color 0.2s;
  cursor: pointer;
}

/* Switch handle */
.switch-handle {
  width: 1rem;
  height: 1rem;
  border-radius: 9999px;
  background-color: #fff; /* handle color */
  position: absolute;
  top: 0.125rem;
  left: 0.125rem;
  transition: transform 0.2s;
}

/* ON state background */
.toggle-switch[data-enabled="true"] {
  background-color: #1f1f1f; /* ON: dark/black */
}
</style>

<script>
// Toggle logic
const adsToggleSwitch = document.getElementById("adsToggleSwitch");
const switchHandle = adsToggleSwitch.querySelector(".switch-handle");

function setSwitchUI(enabled) {
  adsToggleSwitch.dataset.enabled = enabled;
  switchHandle.style.transform = enabled ? "translateX(24px)" : "translateX(0)";
}

// Initial state
let adsEnabled = false; // default OFF
setSwitchUI(adsEnabled);

// Toggle on click
adsToggleSwitch.addEventListener("click", () => {
  adsEnabled = !adsEnabled;
  setSwitchUI(adsEnabled);
  console.log("Ads Enabled:", adsEnabled);

  // TODO: Save to Firebase
});
</script>



    <main class="flex-1 p-4 sm:p-8 container mx-auto">
    <section id="dashboard" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl active">
        <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="total-stock-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                <div>
                    <p class="text-sm font-medium opacity-80">Total Stock Count</p>
                    <p id="total-stock-count" class="text-4xl font-bold"></p>
                </div>
            </div>

            <div class="total-sales-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                <div>
                    <p class="text-sm font-medium opacity-80">Total Sales</p>
                    <p id="total-sales-amount" class="text-4xl font-bold"></p>
                </div>
            </div>
            <div class="low-stock-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4">
                <div>
                    <p class="text-sm font-medium opacity-80">Low Stock Items</p>
                    <p id="low-stock-count" class="text-4xl font-bold"></p>
                </div>
            </div>

            <div class="cash-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4 cursor-pointer" onclick="openDetails('cash')">
                <div>
                    <p class="text-sm font-medium opacity-80">Total Cash</p>
                    <p id="total-cash" class="text-4xl font-bold"></p>
                </div>
            </div>

            <div class="online-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4 cursor-pointer" onclick="openDetails('online')">
                <div>
                    <p class="text-sm font-medium opacity-80">Total Online</p>
                    <p id="total-online" class="text-4xl font-bold"></p>
                </div>
            </div>

            <div class="credit-card card rounded-3xl p-6 shadow-xl flex items-center space-x-4 cursor-pointer" onclick="openDetails('credit')">
                <div>
                    <p class="text-sm font-medium opacity-80">Total Credit</p>
                    <p id="total-credit" class="text-4xl font-bold"></p>
                </div>
            </div>
        </div>

        <div class="bg-gray-50 dark-mode:bg-gray-800 p-6 rounded-2xl shadow-inner">
            <h3 class="text-xl font-bold mb-4">Low Stock Items (<span id="low-stock-count-list"></span>)</h3>
            <div id="low-stock-list" class="overflow-y-auto">
                <table class="min-w-full">
                    <thead class="table-header">
                        <tr class="text-left">
                            <th class="p-3">Code</th>
                            <th class="p-3">Name</th>
                            <th class="p-3">Quantity</th>
                        </tr>
                    </thead>
                    <tbody id="low-stock-table-body" class="divide-y divide-gray-200 dark-mode:divide-gray-700"></tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="details-section" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl hidden">
        <h2 id="details-title" class="text-2xl font-bold mb-6"></h2>
        
        <div class="flex items-center space-x-4 mb-6">
            <input type="date" id="date-filter" class="border rounded-lg p-2" />
            <button onclick="filterByDate()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">Search</button>
        </div>
        
        <div class="overflow-y-auto max-h-96">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="p-3">Date</th>
                        <th class="p-3">Amount</th>
                        <th class="p-3">Description</th>
                    </tr>
                </thead>
                <tbody id="details-table-body" class="divide-y divide-gray-200 dark-mode:divide-gray-700"></tbody>
            </table>
        </div>

        <button onclick="goBack()" class="mt-6 bg-gray-600 text-white px-4 py-2 rounded-lg">Back to Dashboard</button>
    </section>


        <section id="stock" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Stock Management</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 mb-6 items-center">
                <button id="btn-import-csv" class="px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600 col-span-1">Import CSV</button>
                <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                <button id="btn-export-csv" class="px-6 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 col-span-1">Export CSV</button>
                <button id="btn-export-pdf" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 col-span-1">Export PDF</button>
                <input type="text" id="add-stock-code" placeholder="Stock Code" class="p-3 border rounded-xl input-style col-span-1">
                <input type="text" id="add-stock-name" placeholder="Name" class="p-3 border rounded-xl input-style col-span-1">
                <input type="number" id="add-stock-price" placeholder="Price" class="p-3 border rounded-xl input-style col-span-1">
                <input type="number" id="add-stock-quantity" placeholder="Quantity" class="p-3 border rounded-xl input-style col-span-1">
                <button id="btn-add-stock" class="px-6 py-3 btn-primary rounded-xl col-span-full md:col-span-1">Add New Stock</button>
            </div>

            <div class="card p-6 rounded-xl shadow-inner">
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4 space-y-4 sm:space-y-0">
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="select-all-stock" class="form-checkbox h-5 w-5 rounded-md">
                        <label for="select-all-stock">Select All</label>
                    </div>
                    <div class="flex space-x-2">
                        <button id="btn-edit-selected" class="px-4 py-2 bg-yellow-500 text-white rounded-xl hover:bg-yellow-600">Edit Selected</button>
                        <button id="btn-delete-selected" class="px-4 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600">Delete Selected</button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-lg">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr class="text-left">
                                <th class="p-3"></th>
                                <th class="p-3">Code</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Quantity</th>
                                <th class="p-3">Price</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stock-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="invoice" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Create Invoice</h2>
            <div class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Invoice No:</span>
                        <input type="text" id="invoice-no" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 dark-mode:text-gray-200 input-style" readonly>
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Invoice Date:</span>
                        <input type="date" id="invoice-date" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Customer Name:</span>
                        <input type="text" id="customer-name" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Phone:</span>
                        <input type="tel" id="customer-phone" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Email:</span>
                        <input type="email" id="customer-email" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Address:</span>
                        <input type="text" id="customer-address" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                </div>

                <div class="flex items-center gap-4 flex-wrap">
                    <label class="block flex-1">
                        <span class="text-gray-500">Enter Stock Code:</span>
                        <input type="text" id="stock-code-input" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                    </label>
                    <button id="add-item-btn" class="px-6 py-3 bg-emerald-500 text-white rounded-xl hover:bg-emerald-600 self-end">Add Item</button>
                </div>

                <div class="card p-4 rounded-xl shadow-inner overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="table-header">
                            <tr class="text-left">
                                <th class="p-3">Name</th>
                                <th class="p-3">Unit Price</th>
                                <th class="p-3">Quantity</th>
                                <th class="p-3">Discount (%)</th>
                                <th class="p-3">GST (%)</th>
                                <th class="p-3">Total</th>
                                <th class="p-3"></th>
                            </tr>
                        </thead>
                        <tbody id="invoice-item-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>

                <div class="flex flex-col items-end space-y-2 text-right text-lg font-medium">
                    <p class="text-gray-500">Subtotal: <span id="subtotal" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-gray-500">Total Discount: <span id="total-discount" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-gray-500">Total GST: <span id="total-gst" class="text-gray-800 dark-mode:text-gray-200">0.00</span></p>
                    <p class="text-2xl font-bold">Grand Total: <span id="grand-total" class="text-blue-600 dark-mode:text-cyan-400">0.00</span></p>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <label class="block">
                        <span class="text-gray-500">Payment Status:</span>
                        <select id="payment-status" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                            <option value="Full Paid">Full Paid</option>
                            <option value="Partially Paid">Partially Paid</option>
                            <option value="Not Paid">Not Paid</option>
                        </select>
                    </label>
                    <label class="block">
                        <span class="text-gray-500">Payment Mode:</span>
                        <select id="payment-mode" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                            <option value="Cash">Cash</option>
                            <option value="Online">Online</option>
                        </select>
                    </label>
                    <div id="paid-amount-container" class="hidden">
                        <label class="block">
                            <span class="text-gray-500">Paid Amount:</span>
                            <input type="number" id="paid-amount" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                        </label>
                    </div>
                    <label class="block">
                        <span class="text-gray-500">Balance:</span>
                        <input type="number" id="balance" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 dark-mode:text-gray-200 input-style" readonly>
                    </label>
                </div>

                <div class="relative w-full">
                    <button id="save-print-btn" class="w-full px-6 py-4 btn-primary text-xl font-bold rounded-xl">
                        Save & Print Invoice
                    </button>
                </div>
            </div>
        </section>

        <section id="sales" class="content-section card p-6 sm:p-8 rounded-2xl shadow-xl">
            <h2 class="text-2xl font-bold mb-6">Sales Details</h2>
            <div class="mb-4">
                <input type="text" id="sales-search-input" placeholder="Search by Invoice No. or Customer Name" class="w-full p-3 border rounded-xl input-style">
            </div>
            <div class="overflow-x-auto rounded-lg card">
                <table class="min-w-full">
                    <thead class="table-header">
                        <tr class="text-left">
                            <th class="p-3">Date/Time</th>
                            <th class="p-3">Invoice No.</th>
                            <th class="p-3">Customer Name</th>
                            <th class="p-3">Total Amount</th>
                            <th class="p-3">Return Status</th>
                            <th class="p-3 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sales-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <div id="invoice-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-2xl w-full">
            <div class="no-print mt-6 mb-4 flex justify-end space-x-4">
                <button onclick="window.print()" class="no-print px-6 py-3 bg-indigo-500 text-white rounded-xl hover:bg-indigo-600">Print</button>
                <button id="close-invoice-modal" class="no-print px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Done</button>
            </div>
            <div id="invoice-bill-content" class="p-4 border-2 border-dashed border-gray-300 dark-mode:border-gray-600 rounded-lg">
            </div>
        </div>
    </div>

    <div id="edit-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-md w-full">
            <h3 class="text-2xl font-bold mb-4">Edit Stock</h3>
            <div class="space-y-4">
                <label class="block">
                    <span class="text-gray-500">Stock Code:</span>
                    <input type="text" id="edit-stock-code" class="mt-1 block w-full rounded-lg shadow-sm p-3 bg-gray-200 dark-mode:bg-gray-700 dark-mode:text-gray-200 input-style" readonly>
                </label>
                <label class="block">
                    <span class="text-gray-500">Product Name:</span>
                    <input type="text" id="edit-stock-name" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
                <label class="block">
                    <span class="text-gray-500">Quantity:</span>
                    <input type="number" id="edit-stock-quantity" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
                <label class="block">
                    <span class="text-gray-500">Price:</span>
                    <input type="number" id="edit-stock-price" class="mt-1 block w-full rounded-lg shadow-sm p-3 input-style">
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="edit-modal-save" class="px-6 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600">Save Changes</button>
                <button id="edit-modal-cancel" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Back</button>
            </div>
        </div>
    </div>

    <div id="return-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="card p-8 rounded-lg shadow-2xl max-w-xl w-full">
            <h3 class="text-2xl font-bold mb-4">Return Items for Invoice <span id="return-invoice-no"></span></h3>
            <div class="space-y-4">
                <p class="text-sm text-gray-500 italic">Adjust the quantity of items to be returned. Enter 0 for any item you do not wish to return.</p>
                <div class="overflow-y-auto max-h-80 card">
                    <table class="w-full text-left">
                        <thead class="table-header sticky top-0">
                            <tr>
                                <th class="p-2">Item</th>
                                <th class="p-2">Original Qty</th>
                                <th class="p-2">Return Qty</th>
                            </tr>
                        </thead>
                        <tbody id="return-item-list" class="divide-y divide-gray-200 dark-mode:divide-gray-700">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button id="return-modal-confirm" class="px-6 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600">Confirm Return</button>
                <button id="return-modal-cancel" class="px-6 py-3 bg-gray-400 text-white rounded-xl hover:bg-gray-500">Cancel</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, updateDoc, deleteDoc, query, where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCOfYScRtu_r2p1MlDVGT_BSnR4VWe1kIU",
            authDomain: "villagefood-19f8a.firebaseapp.com",
            projectId: "villagefood-19f8a",
            storageBucket: "villagefood-19f8a.firebasestorage.app",
            messagingSenderId: "241737075683",
            appId: "1:241737075683:web:e3a7351cdbdbf77116aed6",
            measurementId: "G-1HH6F13ECS"
        };
        // Init
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // Keys (for compatibility with original code)
        const STOCK_COLLECTION = 'stock';
        const SALES_COLLECTION = 'sales';
        const LOW_STOCK_THRESHOLD = 10;

        // --- Helper: Firestore wrappers ---
        async function getAllDocs(collectionName) {
            const snaps = await getDocs(collection(db, collectionName));
            const data = [];
            snaps.forEach(s => data.push({ id: s.id, ...s.data() }));
            return data;
        }

        async function getDocById(collectionName, id) {
            const dref = doc(db, collectionName, id);
            const snap = await getDoc(dref);
            return snap.exists() ? { id: snap.id, ...snap.data() } : null;
        }

        async function setDocById(collectionName, id, obj) {
            await setDoc(doc(db, collectionName, id), obj);
        }

        async function addDocAuto(collectionName, obj) {
            return await addDoc(collection(db, collectionName), obj);
        }

        async function updateDocById(collectionName, id, obj) {
            await updateDoc(doc(db, collectionName, id), obj);
        }

        async function deleteDocById(collectionName, id) {
            await deleteDoc(doc(db, collectionName, id));
        }
        
        // Loader Functions
        const loader = document.getElementById('loader');
        const showLoader = () => loader.classList.remove('hidden');
        const hideLoader = () => loader.classList.add('hidden');

        // Custom Alert
        function showAlert(message, type = 'info') {
            const alertEl = document.getElementById('custom-alert');
            alertEl.textContent = message;
            alertEl.className = `custom-alert visible ${type}`;
            setTimeout(() => {
                alertEl.classList.remove('visible');
            }, 3000); // Alert disappears after 3 seconds
        }

        // --- UI & State ---
        const sections = {
            dashboard: document.getElementById('dashboard'),
            stock: document.getElementById('stock'),
            invoice: document.getElementById('invoice'),
            sales: document.getElementById('sales')
        };
        const navBtns = document.querySelectorAll('.nav-btn');
        navBtns.forEach(btn => btn.addEventListener('click', async () => {
            const target = btn.dataset.target;
            for (const k in sections) sections[k].classList.remove('active');
            sections[target].classList.add('active');
            navBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            showLoader();
            if (target === 'dashboard') await renderDashboard();
            if (target === 'stock') await renderStock();
            if (target === 'sales') await fetchAllSales();
            hideLoader();
        }));
        document.querySelector('[data-target="dashboard"]').classList.add('active');

        // Theme toggle (unchanged)
        const themeToggleBtn = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const setTheme = (theme) => {
            if (theme === 'dark') { document.body.classList.add('dark-mode'); sunIcon.classList.remove('hidden'); moonIcon.classList.add('hidden'); localStorage.setItem('theme','dark'); }
            else { document.body.classList.remove('dark-mode'); sunIcon.classList.add('hidden'); moonIcon.classList.remove('hidden'); localStorage.setItem('theme','light'); }
        };
        const toggleTheme = () => setTheme(document.body.classList.contains('dark-mode') ? 'light' : 'dark');
        document.addEventListener('DOMContentLoaded', () => setTheme(localStorage.getItem('theme') || 'light'));
        themeToggleBtn.addEventListener('click', toggleTheme);

        // Utility
        const formatCurrency = (amount) => `â‚¹${parseFloat(amount || 0).toFixed(2)}`;
        const generateInvoiceNo = () => `INV-${Date.now()}`;
        
        // NEW: Set invoice date to today
        function setTodayDate() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('invoice-date').value = `${yyyy}-${mm}-${dd}`;
        }

        // UPDATED: Dashboard render to account for returns and payment modes
        async function renderDashboard() {
            const stockData = await getAllDocs(STOCK_COLLECTION);
            const salesData = await getAllDocs(SALES_COLLECTION);

            // --- Total Stock Count ---
            let totalStockCount = 0;
            const lowStockItems = [];
            stockData.forEach(item => {
                totalStockCount += (item.quantity || 0);
                if ((item.quantity || 0) <= LOW_STOCK_THRESHOLD) {
                    lowStockItems.push(item);
                }
            });

            // --- Today's date ---
            const today = new Date().toISOString().slice(0, 10);

            // --- Sales: only today's totals ---
            let totalSalesAmount = 0;
            let totalCash = 0;
            let totalOnline = 0;
            let totalCredit = 0;

            salesData.forEach(s => {
                const saleDate = (s.invoiceDate || '').slice(0, 10);
                if (saleDate === today) {
                    let saleTotal = (s.totals && s.totals.grandTotal) ? s.totals.grandTotal : 0;

                    // Handle returns
                    if (s.returnedItems && s.returnedItems.length > 0) {
                        let returnedValue = 0;
                        s.returnedItems.forEach(returnedItem => {
                            const originalItem = s.items.find(item => item.id === returnedItem.id);
                            if (originalItem) {
                                returnedValue += originalItem.price * returnedItem.quantity;
                            }
                        });
                        saleTotal -= returnedValue;
                    }

                    totalSalesAmount += saleTotal;

                    if (s.paymentMode === 'Cash') totalCash += saleTotal;
                    if (s.paymentMode === 'Online') totalOnline += saleTotal;
                    if (s.paymentStatus === 'Not Paid' || s.paymentStatus === 'Partially Paid') {
                        totalCredit += saleTotal;
                    }
                }
            });


            // --- Update the dashboard UI ---
            document.getElementById('total-stock-count').textContent = totalStockCount;
            document.getElementById('total-sales-amount').textContent = formatCurrency(totalSalesAmount);
            document.getElementById('low-stock-count').textContent = lowStockItems.length;
            document.getElementById('total-cash').textContent = formatCurrency(totalCash);
            document.getElementById('total-online').textContent = formatCurrency(totalOnline);
            document.getElementById('total-credit').textContent = formatCurrency(totalCredit);

            document.getElementById('low-stock-count-list').textContent = lowStockItems.length;
            const lowStockTableBody = document.getElementById('low-stock-table-body');
            lowStockTableBody.innerHTML = '';
            if (lowStockItems.length === 0) {
                lowStockTableBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-400">No items are currently low in stock.</td></tr>';
            } else {
                lowStockItems.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'table-row';
                    row.innerHTML = `<td class="p-3 font-medium">${item.id}</td><td class="p-3">${item.name}</td><td class="p-3 text-red-500 font-semibold">${item.quantity}</td>`;
                    lowStockTableBody.appendChild(row);
                });
            }
        }

        // Stock management
        let selectedStockIds = new Set();
        const stockListEl = document.getElementById('stock-list');

        async function renderStock() {
            const stockData = await getAllDocs(STOCK_COLLECTION);
            stockListEl.innerHTML = '';
            selectedStockIds.clear();

            if (stockData.length === 0) {
                stockListEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No stock items found. Add some new products above.</td></tr>';
                return;
            }

            stockData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                row.innerHTML = `
                    <td class="p-3"><input type="checkbox" data-id="${item.id}" class="stock-checkbox form-checkbox h-4 w-4 rounded-md"></td>
                    <td class="p-3 font-medium">${item.id}</td>
                    <td class="p-3">${item.name}</td>
                    <td class="p-3">${item.quantity}</td>
                    <td class="p-3">${formatCurrency(item.price)}</td>
                    <td class="p-3 space-x-2">
                        <button class="edit-stock-btn px-3 py-1 bg-yellow-500 text-white rounded-lg" data-id="${item.id}">Edit</button>
                        <button class="delete-stock-btn px-3 py-1 bg-red-500 text-white rounded-lg" data-id="${item.id}">Delete</button>
                    </td>
                `;
                stockListEl.appendChild(row);
            });
            stockListEl.querySelectorAll('.stock-checkbox').forEach(cb => cb.addEventListener('change', (e) => {
                const id = e.target.dataset.id;
                if (e.target.checked) selectedStockIds.add(id); else selectedStockIds.delete(id);
                document.getElementById('select-all-stock').checked = (selectedStockIds.size === stockData.length && stockData.length>0);
            }));
            stockListEl.querySelectorAll('.edit-stock-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                const item = await getDocById(STOCK_COLLECTION, id);
                if (item) openEditModal(item);
            }));
            stockListEl.querySelectorAll('.delete-stock-btn').forEach(btn => btn.addEventListener('click', async (e) => {
                const id = e.target.dataset.id;
                if (confirm('Delete this stock item?')) {
                    showLoader();
                    await deleteDocById(STOCK_COLLECTION, id);
                    await renderStock();
                    await renderDashboard();
                    hideLoader();
                }
            }));
        }

        document.getElementById('select-all-stock').addEventListener('change', async (e) => {
            const isChecked = e.target.checked;
            const stockData = await getAllDocs(STOCK_COLLECTION);
            stockListEl.querySelectorAll('.stock-checkbox').forEach(cb => { cb.checked = isChecked; const id=cb.dataset.id; if(isChecked) selectedStockIds.add(id); else selectedStockIds.delete(id); });
        });
        document.getElementById('btn-delete-selected').addEventListener('click', async () => {
            if (selectedStockIds.size===0) { showAlert('Select at least one', 'info'); return; }
            if (!confirm('Delete selected items?')) return;
            showLoader();
            for (const id of selectedStockIds) { await deleteDocById(STOCK_COLLECTION, id); }
            selectedStockIds.clear(); await renderStock(); await renderDashboard();
            hideLoader();
        });
        // Edit modal logic
        const editModal = document.getElementById('edit-modal');
        let currentEditingId = null;
        function openEditModal(item) {
            currentEditingId = item.id;
            document.getElementById('edit-stock-code').value = item.id;
            document.getElementById('edit-stock-name').value = item.name;
            document.getElementById('edit-stock-quantity').value = item.quantity;
            document.getElementById('edit-stock-price').value = item.price;
            editModal.classList.remove('hidden');
        }
        document.getElementById('edit-modal-save').addEventListener('click', async () => {
            const id = currentEditingId;
            const name = document.getElementById('edit-stock-name').value.trim();
            const quantity = parseInt(document.getElementById('edit-stock-quantity').value,10);
            const price = parseFloat(document.getElementById('edit-stock-price').value);
            if (name && !isNaN(quantity) && !isNaN(price)) {
                
                showLoader();
                await setDocById(STOCK_COLLECTION, id, { id, name, quantity, price });
                showAlert('Stock item updated successfully!', 'success'); editModal.classList.add('hidden'); await renderStock(); await renderDashboard();
                hideLoader();
            } else { showAlert('Fill all fields correctly', 'error'); }
        });
        document.getElementById('edit-modal-cancel').addEventListener('click', () => editModal.classList.add('hidden'));

        // CSV import/export (reads file and writes to Firestore)
        const csvFileInput = document.getElementById('csv-file-input');
        document.getElementById('btn-import-csv').addEventListener('click', () => csvFileInput.click());
        csvFileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0]; if(!file) return;
            showLoader();
            const text = await file.text();
            const rows = text.split(/\r?\n/).map(r=>r.trim()).filter(r=>r.length>0);
            if (rows.length<=1) { showAlert('CSV empty or only headers', 'error'); hideLoader(); return; }
            for (let i=1;i<rows.length;i++){
                
                const [stockCode,name,price,quantity] = rows[i].split(',').map(x=>x.trim());
                if (stockCode && name && !isNaN(parseFloat(price)) && !isNaN(parseInt(quantity,10))) {
                    await setDocById(STOCK_COLLECTION, stockCode, { id: stockCode, name, price: parseFloat(price), quantity: parseInt(quantity,10) });
                }
            }
            
            showAlert('Import complete', 'success'); await renderStock(); await renderDashboard();
            hideLoader();
        });
        document.getElementById('btn-export-csv').addEventListener('click', async () => {
            showLoader();
            const stockData = await getAllDocs(STOCK_COLLECTION);
            if (stockData.length===0) { showAlert('No data to export', 'info'); hideLoader(); return; }
            const headers = ['Stock Code','Name','Quantity','Price'];
            const csv = [headers.join(','), ...stockData.map(i=>`${i.id},"${i.name}",${i.quantity},${i.price}`)].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            
            const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = 'stock_data.csv'; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            hideLoader();
        });
        document.getElementById('btn-export-pdf').addEventListener('click', () => showAlert('PDF export requires a library like jsPDF (not included).', 'info'));


        // --- Invoice logic ---
        const stockCodeInput = document.getElementById('stock-code-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const invoiceItemListEl = document.getElementById('invoice-item-list');
        const savePrintBtn = document.getElementById('save-print-btn');
        const invoiceModal = document.getElementById('invoice-modal');
        const invoiceBillContent = document.getElementById('invoice-bill-content');
        
        const paymentStatusSelect = document.getElementById('payment-status');
        const paidAmountContainer = document.getElementById('paid-amount-container');
        const paidAmountInput = document.getElementById('paid-amount');
        const paymentModeSelect = document.getElementById('payment-mode'); // Added payment mode select

        paymentStatusSelect.addEventListener('change', (e) => {
            const status = e.target.value;
            if (status === 'Partially Paid') {
                paidAmountContainer.classList.remove('hidden');
            } else {
                paidAmountContainer.classList.add('hidden');
                paidAmountInput.value = '';
            }
            updateInvoiceTotals();
        });


        let invoiceItems = [];
        stockCodeInput.addEventListener('keydown', (e)=>{ if(e.key==='Tab'){ e.preventDefault(); addItemBtn.click(); } });

        addItemBtn.addEventListener('click', async () => {
            const stockCode = stockCodeInput.value.trim(); if(!stockCode){ showAlert('Enter stock code', 'info'); return; }
            const stockItem = await getDocById(STOCK_COLLECTION, stockCode);
            if (!stockItem) { showAlert('Stock code not found', 'error'); return; }
            if (stockItem.quantity < 1) { showAlert('Stock is zero', 'warning'); return; }
            
            const existing = invoiceItems.find(it => it.id === stockCode);
            if (existing) { showAlert('Item already added', 'warning'); stockCodeInput.value=''; return; }
            invoiceItems.push({ id: stockItem.id, name: stockItem.name, price: stockItem.price, quantity: 1, discount:0, gst:18 });
            renderInvoiceItems(); updateInvoiceTotals(); stockCodeInput.value='';
        });
        function renderInvoiceItems(){
            invoiceItemListEl.innerHTML='';
            if (invoiceItems.length===0) { invoiceItemListEl.innerHTML='<tr><td colspan="7" class="p-4 text-center text-gray-400">No items added to invoice.</td></tr>'; return; }
            invoiceItems.forEach((item,index)=>{
                const total = (item.quantity*item.price)*(1-item.discount/100)*(1+item.gst/100);
                const row = document.createElement('tr'); row.className='table-row';
                row.innerHTML = `
                    <td class="p-3 font-medium">${item.name}</td>
                    <td class="p-3">${formatCurrency(item.price)}</td>
                    <td class="p-3">
                        <div class="flex items-center space-x-2">
                            <button class="qty-dec px-2 py-1 rounded-md" data-index="${index}">-</button>
                            <input type="number" value="${item.quantity}" min="1" class="w-16 text-center border rounded-md p-1 quantity-input" data-index="${index}">
                            <button class="qty-inc px-2 py-1 rounded-md" data-index="${index}">+</button>
                        </div>
                    </td>
                    <td class="p-3"><input type="number" value="${item.discount}" min="0" max="100" class="w-16 border rounded-md p-1" data-index="${index}" data-field="discount"></td>
                    <td class="p-3 text-gray-500">${item.gst}%</td>
                    <td class="p-3 font-semibold">${formatCurrency(total)}</td>
                    <td class="p-3"><button class="remove-item-btn text-red-500" data-index="${index}">x</button></td>
                `;
                invoiceItemListEl.appendChild(row);
            });

            invoiceItemListEl.querySelectorAll('.qty-inc').forEach(btn=>btn.addEventListener('click', async (e)=>{ const index = parseInt(e.target.dataset.index); const stockItem = await getDocById(STOCK_COLLECTION, invoiceItems[index].id); if(invoiceItems[index].quantity < (stockItem?stockItem.quantity:invoiceItems[index].quantity)){ invoiceItems[index].quantity++; renderInvoiceItems(); updateInvoiceTotals(); } else showAlert('Cannot exceed available stock.', 'warning'); }));
            invoiceItemListEl.querySelectorAll('.qty-dec').forEach(btn=>btn.addEventListener('click',(e)=>{ const index=parseInt(e.target.dataset.index); if(invoiceItems[index].quantity>1){ invoiceItems[index].quantity--; renderInvoiceItems(); updateInvoiceTotals(); } }));
            invoiceItemListEl.querySelectorAll('input[data-field]').forEach(input=>input.addEventListener('input',(e)=>{ const index=parseInt(e.target.dataset.index); const field=e.target.dataset.field; let val=parseFloat(e.target.value); if(field==='discount'){ if(val<0) val=0; if(val>100) val=100; invoiceItems[index].discount=val; } renderInvoiceItems(); updateInvoiceTotals(); }));
            invoiceItemListEl.querySelectorAll('.quantity-input').forEach(inp=>inp.addEventListener('input', async (e)=>{ const index=parseInt(e.target.dataset.index); let val=parseInt(e.target.value,10); if(isNaN(val)||val<1) val=1; const stockItem = await getDocById(STOCK_COLLECTION, invoiceItems[index].id); if(stockItem && val>stockItem.quantity){ showAlert('Cannot exceed available stock', 'warning'); val=stockItem.quantity; e.target.value=val; } invoiceItems[index].quantity=val; renderInvoiceItems(); updateInvoiceTotals(); }));
            invoiceItemListEl.querySelectorAll('.remove-item-btn').forEach(btn=>btn.addEventListener('click',(e)=>{ const index=parseInt(e.target.dataset.index); invoiceItems.splice(index,1); renderInvoiceItems(); updateInvoiceTotals(); }));
        }

        function updateInvoiceTotals(){
            let subtotal = 0, totalDiscount = 0, totalGST = 0, grandTotal = 0;
            invoiceItems.forEach(item => {
                const base = item.price * item.quantity;
                const discountAmount = base * (item.discount/100);
                const afterDiscount = base - discountAmount;
                const gstAmount = afterDiscount * (item.gst/100);
                
                const total = afterDiscount + gstAmount;
                subtotal += base;
                totalDiscount += discountAmount;
                totalGST += gstAmount;
                grandTotal += total;
            });
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('total-discount').textContent = formatCurrency(totalDiscount);
            document.getElementById('total-gst').textContent = formatCurrency(totalGST);
            document.getElementById('grand-total').textContent = formatCurrency(grandTotal);
            const paidAmount = parseFloat(paidAmountInput.value) || 0;
            const status = paymentStatusSelect.value;
            if(status === 'Full Paid') {
                paidAmountInput.value = grandTotal.toFixed(2);
                document.getElementById('balance').value = 0;
            } else if (status === 'Not Paid') {
                paidAmountInput.value = 0;
                document.getElementById('balance').value = -grandTotal.toFixed(2);
            } else {
                document.getElementById('balance').value = (paidAmount - grandTotal).toFixed(2);
            }
        }
        
        paidAmountInput.addEventListener('input', updateInvoiceTotals);
        
        // UPDATED: Save and Print function with QR code
        savePrintBtn.addEventListener('click', async () => {
    if (invoiceItems.length === 0) {
        showAlert('Add at least one item', 'info');
        return;
    }

    const invoiceNo = document.getElementById('invoice-no').value || generateInvoiceNo();
    const invoiceDate = document.getElementById('invoice-date').value || new Date().toISOString().slice(0,10);
    const customerName = document.getElementById('customer-name').value;
    const customerPhone = document.getElementById('customer-phone').value;
    const customerEmail = document.getElementById('customer-email').value;
    const customerAddress = document.getElementById('customer-address').value;
    const paymentStatus = paymentStatusSelect.value;
    const paymentMode = paymentModeSelect.value; // Cash / Online / Credit
    let paidAmount = parseFloat(paidAmountInput.value) || 0;
    const grandTotal = parseFloat(document.getElementById('grand-total').textContent.replace('â‚¹', ''));

    if (paymentStatus === 'Full Paid') {
        paidAmount = grandTotal;
    } else if (paymentStatus === 'Not Paid') {
        paidAmount = 0;
    }

    // âœ… Correct balance (Grand Total â€“ Paid)
    const balance = grandTotal - paidAmount;

    // Totals calculation
    let totals = { subtotal: 0, discount: 0, gst: 0, grandTotal: 0 };
    invoiceItems.forEach(it => {
        const itemSubtotal = it.price * it.quantity;
        const itemDiscount = itemSubtotal * (it.discount / 100);
        const afterDiscount = itemSubtotal - itemDiscount;
        const itemGST = afterDiscount * (it.gst / 100);
        totals.subtotal += itemSubtotal;
        totals.discount += itemDiscount;
        totals.gst += itemGST;
        totals.grandTotal += afterDiscount + itemGST;
    });

    // âœ… Split by payment mode (for dashboard)
    let cashAmount = 0, onlineAmount = 0, creditAmount = 0;
    if (paymentMode === 'Cash') cashAmount = paidAmount;
    if (paymentMode === 'Online') onlineAmount = paidAmount;
    if (paymentMode === 'Credit') creditAmount = paidAmount;

    const invoiceData = {
        invoiceNo,
        invoiceDate,
        customer: {
            name: customerName,
            phone: customerPhone,
            email: customerEmail,
            address: customerAddress
        },
        items: invoiceItems,
        paymentStatus,
        paymentMode,
        paidAmount,
        balance,
        totals,
        cashAmount,   // ðŸ”¹ Store explicitly for dashboard
        onlineAmount, // ðŸ”¹
        creditAmount, // ðŸ”¹
        timestamp: Date.now(),
        returned: false,
        returnedItems: []
    };

            
            showLoader();
            await setDocById(SALES_COLLECTION, invoiceNo, invoiceData);
            for(const it of invoiceItems){
                const stock = await getDocById(STOCK_COLLECTION,it.id);
                if(stock){ await updateDocById(STOCK_COLLECTION,it.id,{...stock, quantity: stock.quantity - it.quantity}); }
            }

            showAlert('Invoice saved!', 'success');
            await fetchAllSales(); await renderStock(); await renderDashboard();

            // Show invoice bill modal
            const upiId = 'jeyajegadeesh1606-1@oksbi';
const qrCodeSection = paymentMode === 'Online' ? `
<div style="text-align:center; margin: 30px 0;">
    <p style="font-weight: 600; margin-bottom: 10px; color:#0f172a;">Scan to Pay</p>
    <div id="qr-code-placeholder" style="display:inline-block; background:#fff; padding:12px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1);"></div>
</div>
` : '';

const billHtml = `
  <div style="font-family: 'Inter', sans-serif; font-size: 14px; color: #1e293b; background: #f9fafb; padding: 32px; border-radius: 16px; max-width: 860px; margin: auto; box-shadow: 0 6px 20px rgba(0,0,0,0.08);">
    
    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px;">
      <div>
        <h1 style="font-size: 28px; font-weight: 800; margin: 0; color:#0f172a;">MULLAI ENTERPRISES</h1>
        <p style="font-size: 16px; margin: 6px 0; color:#334155;">PAINTS & ELECTRICALS</p>
        <p style="margin: 4px 0; color:#475569;"><strong>Head office:</strong> 107/D6, Subban Street, Thittasalai, Theni - 625 531</p>
        <p style="margin: 4px 0; color:#475569;"><strong>Branch:</strong> Krishna Nagar Petrol pump side, Thevaram Main Road, Bodinayakanur - 625 513</p>
        <p style="margin: 4px 0; color:#475569;"><strong>GSTIN:</strong> 33ABHFM0000G2ZX</p>
      </div>
      <div style="text-align: right; font-size: 14px; color:#334155;">
        <p style="margin: 0; font-weight: 600;">ðŸ“ž Contact</p>
        <p style="margin: 2px 0;">Bodi: 6745985432</p>
        <p style="margin: 2px 0;">Theni: 7856342198</p>
      </div>
    </div>

    <div style="height:2px; background:linear-gradient(to right,#3b82f6,#06b6d4); margin:20px 0; border-radius:4px;"></div>

    <div style="display: flex; justify-content: space-between; margin-bottom: 24px; background:#fff; padding:16px 20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
      <div>
        <p style="margin: 2px 0; font-weight:600;"><span style="color:#3b82f6;">Customer:</span> ${customerName || 'Walk-in'}</p>
        <p style="margin: 2px 0;"><strong>Phone:</strong> ${customerPhone || ''}</p>
        <p style="margin: 2px 0;"><strong>Address:</strong> ${customerAddress || 'N/A'}</p>
      </div>
      <div style="text-align: right;">
        <p style="margin: 2px 0;"><strong>Invoice No:</strong> ${invoiceNo}</p>
        <p style="margin: 2px 0;"><strong>Date:</strong> ${invoiceDate}</p>
      </div>
    </div>

    <table style="width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 24px; font-size: 14px; background:#fff; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
      <thead>
        <tr style="background: linear-gradient(to right, #3b82f6, #06b6d4); color:#fff;">
          <th style="text-align: left; padding: 12px;">Item</th>
          <th style="text-align: right; padding: 12px;">Qty</th>
          <th style="text-align: right; padding: 12px;">Price</th>
          <th style="text-align: right; padding: 12px;">Discount</th>
          <th style="text-align: right; padding: 12px;">GST</th>
          <th style="text-align: right; padding: 12px;">Total</th>
        </tr>
      </thead>
      <tbody>
        ${invoiceItems.map(item => `
          <tr style="border-bottom: 1px solid #e2e8f0;">
            <td style="padding: 12px;">${item.name}</td>
            <td style="text-align: right; padding: 12px;">${item.quantity}</td>
            <td style="text-align: right; padding: 12px;">${formatCurrency(item.price)}</td>
            <td style="text-align: right; padding: 12px;">${item.discount}%</td>
            <td style="text-align: right; padding: 12px;">${item.gst}%</td>
            <td style="text-align: right; padding: 12px; font-weight:600; color:#0f172a;">${formatCurrency((item.price * item.quantity * (1 - item.discount / 100)) * (1 + item.gst / 100))}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div style="text-align: right; background:#fff; padding:16px 20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.05); font-size: 14px;">
      <p style="margin: 6px 0;"><strong>Subtotal:</strong> ${formatCurrency(totals.subtotal)}</p>
      <p style="margin: 6px 0;"><strong>Total Discount:</strong> ${formatCurrency(totals.discount)}</p>
      <p style="margin: 6px 0;"><strong>Total GST:</strong> ${formatCurrency(totals.gst)}</p>
      <p style="font-size: 18px; font-weight: 700; margin: 15px 0; color:#3b82f6;"><strong>Grand Total:</strong> ${formatCurrency(totals.grandTotal)}</p>
      <p style="margin: 6px 0;"><strong>Payment Status:</strong> ${paymentStatus}</p>
      <p style="margin: 6px 0;"><strong>Payment Mode:</strong> ${paymentMode}</p>
      <p style="margin: 6px 0;"><strong>Paid Amount:</strong> ${formatCurrency(paidAmount)}</p>
      <p style="margin: 6px 0; font-weight:600; color:${balance > 0 ? '#dc2626' : '#16a34a'};"><strong>Balance:</strong> ${formatCurrency(balance)}</p>
    </div>

    ${qrCodeSection}

    <p style="text-align: center; font-size: 15px; font-style: italic; color:#475569; margin-top: 20px;">âœ¨ Thank you for your business! âœ¨</p>
  </div>
`;

            invoiceBillContent.innerHTML = billHtml;

            if (paymentMode === 'Online') {
                const qrPlaceholder = document.getElementById('qr-code-placeholder');
                if (qrPlaceholder) {
                    const upiLink = `upi://pay?pa=${upiId}&pn=Mullai%20Store&am=${paidAmount.toFixed(2)}&cu=INR`;
                    new QRCode(qrPlaceholder, {
                        text: upiLink,
                        width: 300,
                        height: 300,
                        colorDark: "#000000",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                }
            }


            invoiceModal.classList.remove('hidden');
            invoiceItems = [];
            renderInvoiceItems(); updateInvoiceTotals();
            hideLoader();
        });

        document.getElementById('close-invoice-modal').addEventListener('click',()=>invoiceModal.classList.add('hidden'));

        // --- Sales rendering with search/filter ---
        const salesSearchInput = document.getElementById('sales-search-input');
        let allSalesData = [];

        async function fetchAllSales() {
            allSalesData = await getAllDocs(SALES_COLLECTION);
            allSalesData.sort((a, b) => b.timestamp - a.timestamp); // Sort by timestamp descending
            renderSales();
        }

        // UPDATED: Render sales with return status and actions
        async function renderSales() {
            const salesListEl = document.getElementById('sales-list');
            salesListEl.innerHTML = '';
            
            const searchTerm = salesSearchInput.value.toLowerCase().trim();
            const filteredSales = allSalesData.filter(sale => 
                sale.invoiceNo.toLowerCase().includes(searchTerm) || 
                (sale.customer.name && sale.customer.name.toLowerCase().includes(searchTerm))
            );

            if(filteredSales.length === 0){
                salesListEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-400">No matching sales records found.</td></tr>';
                return;
            }

            filteredSales.forEach(sale => {
                const row = document.createElement('tr');
                row.className = 'table-row';
                const status = sale.returned ? 'Returned' : 'OK';
                row.innerHTML = `
                    <td class="p-3">${new Date(sale.timestamp).toLocaleString()}</td>
                    <td class="p-3">${sale.invoiceNo}</td>
                    <td class="p-3">${sale.customer.name}</td>
                    <td class="p-3">${formatCurrency(sale.totals.grandTotal)}</td>
                    <td class="p-3">${status}</td>
                    <td class="p-3 text-center space-x-2">
                        <button class="view-invoice-btn px-3 py-1 bg-indigo-500 text-white rounded-lg" data-id="${sale.invoiceNo}">View</button>
                        <button class="return-invoice-btn px-3 py-1 bg-red-500 text-white rounded-lg" data-id="${sale.invoiceNo}" ${sale.returned ? 'disabled' : ''}>Return</button>
                    </td>`;
                salesListEl.appendChild(row);
            });
            
            // UPDATED: View invoice function to handle returned items
            salesListEl.querySelectorAll('.view-invoice-btn').forEach(btn => btn.addEventListener('click', async e => {
                const id = e.target.dataset.id;
                const sale = await getDocById(SALES_COLLECTION, id);
                if(sale){
                    // Calculate net total for display
                    let netTotal = sale.totals.grandTotal;
                    let returnedValue = 0;
                    if (sale.returnedItems && sale.returnedItems.length > 0) {
                        sale.returnedItems.forEach(returnedItem => {
                            const originalItem = sale.items.find(item => item.id === returnedItem.id);
                            if (originalItem) {
                                returnedValue += originalItem.price * returnedItem.quantity;
                            }
                        });
                        netTotal -= returnedValue;
                    }
                    
                    const returnedItemsHtml = sale.returnedItems && sale.returnedItems.length > 0 ? `
                        <h4 style="font-size: 16px; font-weight: bold; margin-top: 20px;">Returned Items</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                            <thead>
                                <tr style="background-color: #f3f4f6;">
                                    <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">Item</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Return Qty</th>
                                    <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sale.returnedItems.map(item => `
                                    <tr>
                                        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${sale.items.find(i=>i.id===item.id).name}</td>
                                        <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${item.quantity}</td>
                                        <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(item.quantity * sale.items.find(i=>i.id===item.id).price)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    ` : '';
                    
                    const upiId = 'jeyajegadeesh1606-1@oksbi'; // <-- UPDATED: Your UPI ID
                    const qrCodeSection = sale.paymentMode === 'Online' ? `
                        <div class="qr-code-container">
                            <p style="font-weight: bold;">Scan to Pay</p>
                            <div id="qr-code-placeholder"></div>
                        </div>
                    ` : '';

                    const billHtml = `
                        <div style="font-family: 'Inter', sans-serif; font-size: 14px; color: black; background-color: white; padding: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                                <div style="text-align: left;">
                                    <h2 style="font-size: 24px; font-weight: bold; margin: 0; padding: 0;">MULLAI ENTERPRISES</h2>
                                    <p style="font-size: 16px; margin: 0; padding: 0;">PAINTS & ELECTRICALS</p>
                                    <p style="margin: 5px 0 0 0;"><strong>Head office:</strong> 107/D6, Subban Street, Thittasalai, Theni - 625 531</p>
                                    <p style="margin: 0;"><strong>Branch:</strong> Krishna Nagar Petrol pump side, Thevaram Main Road, Bodinayakanur - 625 513</p>
                                    <p style="margin: 5px 0 0 0;"><strong>GSTIN:</strong> 33ABHFM0000G2ZX</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 0; font-weight: bold;">Contact Numbers</p>
                                    <p style="margin: 0;">Bodi: 6745985432</p>
                                    <p style="margin: 0;">Theni: 7856342198</p>
                                </div>
                            </div>
                            <hr style="border: 1px solid #e5e7eb; margin: 20px 0;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                                <div>
                                    <p style="margin: 0;"><strong>Customer:</strong> ${sale.customer.name || 'Walk-in'}</p>
                                    <p style="margin: 0;"><strong>Phone:</strong> ${sale.customer.phone || 'N/A'}</p>
                                    <p style="margin: 0;"><strong>Address:</strong> ${sale.customer.address || 'N/A'}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p style="margin: 0;"><strong>Invoice No:</strong> ${sale.invoiceNo}</p>
                                    <p style="margin: 0;"><strong>Date:</strong> ${sale.invoiceDate}</p>
                                </div>
                            </div>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                                <thead>
                                    <tr style="background-color: #f3f4f6;">
                                        <th style="text-align: left; padding: 10px; border-bottom: 2px solid #e5e7eb;">Item</th>
                                        <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Qty</th>
                                        <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Price</th>
                                        <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Discount (%)</th>
                                        <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">GST (%)</th>
                                        <th style="text-align: right; padding: 10px; border-bottom: 2px solid #e5e7eb;">Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${sale.items.map(item => `
                                        <tr>
                                            <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">${item.name}</td>
                                            <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${item.quantity}</td>
                                            <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${formatCurrency(item.price)}</td>
                                            <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${item.discount}%</td>
                                            <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${item.gst}%</td>
                                            <td style="text-align: right; padding: 10px; border-bottom: 1px solid #e5e7eb;">${formatCurrency((item.price * item.quantity * (1 - item.discount / 100)) * (1 + item.gst / 100))}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            ${returnedItemsHtml}
                            <div style="text-align: right; margin-top: 20px;">
                                <p style="margin: 5px 0;"><strong>Subtotal:</strong> ${formatCurrency(sale.totals.subtotal)}</p>
                                <p style="margin: 5px 0;"><strong>Total Discount:</strong> ${formatCurrency(sale.totals.discount)}</p>
                                <p style="margin: 5px 0;"><strong>Total GST:</strong> ${formatCurrency(sale.totals.gst)}</p>
                                <p style="font-size: 18px; font-weight: bold; margin: 15px 0;"><strong>Grand Total:</strong> ${formatCurrency(sale.totals.grandTotal)}</p>
                                ${returnedValue > 0 ? `<p style="font-size: 18px; font-weight: bold; margin: 15px 0; color: red;"><strong>Amount Returned:</strong> -${formatCurrency(returnedValue)}</p>` : ''}
                                ${returnedValue > 0 ? `<p style="font-size: 18px; font-weight: bold; margin: 15px 0;"><strong>Net Total:</strong> ${formatCurrency(netTotal)}</p>` : ''}
                                <p style="margin: 5px 0;"><strong>Payment Status:</strong> ${sale.paymentStatus}</p>
                                <p style="margin: 5px 0;"><strong>Payment Mode:</strong> ${sale.paymentMode}</p>
                                <p style="margin: 5px 0;"><strong>Paid Amount:</strong> ${formatCurrency(sale.paidAmount)}</p>
                                <p style="margin: 5px 0;"><strong>Balance:</strong> ${formatCurrency(sale.balance)}</p>
                            </div>
                            ${qrCodeSection}
                            <hr style="border: 1px dashed #e5e7eb; margin: 20px 0;">
                            <p style="text-align: center; font-size: 16px; font-style: italic;">Thank you for your business!</p>
                        </div>
                    `;
                    invoiceBillContent.innerHTML = billHtml;

                    if (sale.paymentMode === 'Online') {
                        const qrPlaceholder = document.getElementById('qr-code-placeholder');
                        if (qrPlaceholder) {
                            const upiLink = `upi://pay?pa=${upiId}&pn=Mullai%20Store&am=${netTotal.toFixed(2)}&cu=INR`;
                            new QRCode(qrPlaceholder, {
                                text: upiLink,
                                width: 150,
                                height: 150,
                                colorDark: "#000000",
                                colorLight: "#ffffff",
                                correctLevel: QRCode.CorrectLevel.H
                            });
                        }
                    }

                    invoiceModal.classList.remove('hidden');
                }
            }));

            // UPDATED: Return function to store returned items
            salesListEl.querySelectorAll('.return-invoice-btn').forEach(btn => btn.addEventListener('click', async e => {
                const id = e.target.dataset.id;
                const sale = await getDocById(SALES_COLLECTION, id);
                if (!sale) return;
                
                // Show return modal with all items and their original quantities
                document.getElementById('return-invoice-no').textContent = id;
                const returnItemList = document.getElementById('return-item-list');
                returnItemList.innerHTML = '';
                sale.items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="p-2">${item.name}</td>
                        <td class="p-2">${item.quantity}</td>
                        <td class="p-2">
                            <input type="number" data-id="${item.id}" max="${item.quantity}" min="0" value="0" class="w-16 p-1 border rounded input-style">
                        </td>
                    `;
                    returnItemList.appendChild(row);
                });

                document.getElementById('return-modal-confirm').onclick = async () => {
                    showLoader();
                    const returnQuantities = Array.from(returnItemList.querySelectorAll('input')).map(input => ({
                        id: input.dataset.id,
                        quantity: parseInt(input.value, 10) || 0
                    }));

                    const anyItemsToReturn = returnQuantities.some(item => item.quantity > 0);
                    if (!anyItemsToReturn) {
                        showAlert('No items selected for return.', 'info');
                        hideLoader();
                        return;
                    }

                    const returnedItemsList = returnQuantities.filter(item => item.quantity > 0);
                    
                    for(const it of returnedItemsList) {
                        const stock = await getDocById(STOCK_COLLECTION, it.id);
                        if (stock) { await updateDocById(STOCK_COLLECTION, it.id, { ...stock, quantity: stock.quantity + it.quantity }); }
                    }
                    
                    await updateDocById(SALES_COLLECTION, id, {
                        ...sale,
                        returned: true, // Mark as returned to prevent future returns on this invoice
                        returnedItems: returnedItemsList // Store returned items
                    });
                    
                    showAlert('Return processed successfully!', 'success');
                    document.getElementById('return-modal').classList.add('hidden');
                    await fetchAllSales();
                    await renderStock();
                    await renderDashboard();
                    hideLoader();
                };

                document.getElementById('return-modal-cancel').onclick = () => {
                    document.getElementById('return-modal').classList.add('hidden');
                };
                
                document.getElementById('return-modal').classList.remove('hidden');
            }));
            
            document.getElementById('sales-search-input').addEventListener('input', renderSales);
        }
        
        // Init: render dashboard on load
        document.addEventListener('DOMContentLoaded', async () => {
            showLoader();
            await renderDashboard();
            await fetchAllSales();
            hideLoader();
        });
    </script>
</body>
</html>
